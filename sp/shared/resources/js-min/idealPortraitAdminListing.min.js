angular.module("spApp").directive("idealPortraitAdminListing",["spConfig","sharedProperties","spValue","$q","$rootScope","$state","idealPortraitAdminService","memberService","ngDialog","$timeout",function(spConfig,sharedProperties,spValue,$q,$rootScope,$state,idealPortraitAdminService,memberService,ngDialog,$timeout){return{restrict:"EA",replace:!0,templateUrl:function(element,attrs){return"/sp/resources/html/sysAdmin/peopleAnalytics/Ideal-Portrait/view/"+attrs.urlSrc},link:function(scope,element,attrs){function createdUserSelectedVariable(){vm.totalSelected=0;for(var key in vm.portraitMatch.categoryDataMap)for(var el in vm.portraitMatch.categoryDataMap[key])if(vm.portraitMatch.categoryDataMap[key][el].enabled&&(vm.filterSelected[key].push(el),vm.totalSelected++),"Personality"===key&&-1!==vm.filterSelected[key].indexOf(el))for(var i=0,e=vm.portraitMatch.categoryDataMap[key][el];i<e.matchCriterias.length;i++)vm.addedTraits[el].push(e.matchCriterias[i].key),vm.matchDropDown[el][vm.indexDrop.indexOf(e.matchCriterias[i].matchPercent)].checked=!0,vm.matchDropDown[el+"Selected"].push(e.matchCriterias[i].key);else if("Personality"===key&&-1===vm.filterSelected[key].indexOf(el))for(var ii=0,ee=vm.portraitMatch.categoryDataMap[key][el];ii<ee.matchCriterias.length;ii++)vm.addedTraits[el].push(ee.matchCriterias[ii].key),vm.matchDropDown[el][vm.indexDrop.indexOf(ee.matchCriterias[ii].matchPercent)].checked=!0,vm.matchDropDown[el+"Selected"].push(ee.matchCriterias[ii].key);else"ConflictManagement"!==key&&"FundamentalNeeds"!==key||vm.portraitMatch.categoryDataMap[key][el].matchCriterias.length&&(vm.active[key]="Secondary",vm[key].addedList.push(vm.portraitMatch.categoryDataMap[key][el].matchCriterias[0].key));vm.previewDetail()}function filterByCompany(portraitCompanyObj,companyId,flag){var idMap=portraitCompanyObj&&portraitCompanyObj.length?portraitCompanyObj.map(function(e){return e.id}):[],_flag=!1;return flag&&idMap.length&&-1!==idMap.indexOf(companyId)?_flag=!0:!flag&&idMap.length&&-1===idMap.indexOf(companyId)&&(_flag=!0),_flag}var vm=scope;vm.selectedTab=0,vm.pageSetting={pageSize:20,textSearching:"",textSearching0:"",textSearching1:"",disabledInfinite:!1},vm.originalPageSetting=angular.copy(vm.pageSetting),vm.portraitMatchListing=[],vm.portraitMatchCompanies=[],vm.companyPortraitsList=[],vm.companyPortraitsListMaster=[],vm.companyAddList=[],vm.companyExistingList=[],vm.selectedCompanyObj={},vm.responseRecieved=!1,vm.showCompanyPortraits=!1,vm.companyId=null,vm.portraitId=null,vm.maximumTrait=5,vm.lastcategoryPriorityWeightMap={},vm.addedTraits={Primary:[],UnderPressure:[]},vm.matchDropDown={Primary:[{name:100,checked:!1},{name:90,checked:!1},{name:80,checked:!1}],UnderPressure:[{name:100,checked:!1},{name:90,checked:!1},{name:80,checked:!1}],PrimarySelected:[],UnderPressureSelected:[]},vm.indexDrop=[100,90,80],vm.personalityTraits=["Supporter","Actuary","Ambassador","Visionary","Motivator","Examiner","Instructor","Promoter","Encourager","Innovator","Researcher","Pragmatist","Refiner","Navigator","Designer","Tough_N_Tender"],vm.traitDescription=["Powerfull","Adaptable","Versatile","Precise"],vm.active={ConflictManagement:"Primary",FundamentalNeeds:"Primary"},vm.ConflictManagement={list:[{name:"Collaborate",Primary:!0,Secondary:!0},{name:"Compete",Primary:!0,Secondary:!0},{name:"Accommodate",Primary:!0,Secondary:!0},{name:"Compromise",Primary:!1,Secondary:!0},{name:"Avoid",Primary:!1,Secondary:!0}],addedList:[]},vm.FundamentalNeeds={list:[{name:"Control",Primary:!0,Secondary:!0},{name:"Significance",Primary:!0,Secondary:!0},{name:"Security",Primary:!1,Secondary:!0}],addedList:[]},vm.filterSelected={ConflictManagement:[],FundamentalNeeds:[],Motivation:[],Processing:[],LearningStyle:[],Personality:[],DecisionMaking:[]},vm.totalSelected=0,vm.totalTraits=21;vm.fileStackData={},vm.fileStackMimeType="",vm.contextPortraitId=null,vm.contextCompanyId=null,vm.contextUrl=null,vm.attachmentsList=[],vm.uploadLaterFlag=!1,vm.isDocumentUrl=function(portraitObj,companyId){for(var url=!1,companiesObj=portraitObj.companies,i=0;i<companiesObj.length;i++)if(companiesObj[i].id===companyId&&null!==companiesObj[i].documentUrl){vm.attachmentsList[portraitObj.id]=companiesObj[i].documentUrl,url=!0;break}return url};scope.$on("fileStackSuccessNotes",function(e,data){if(null===data)return!0;var mediaType=sharedProperties.mapMediaType(data.fileData.mimetype);vm.fileStackData.title=data.fileData.filename,vm.fileStackData.description=null,vm.fileStackData.authorSource=null,vm.fileStackData.media=[],vm.fileStackData.media.push({id:null,name:null,altText:null,tags:null,url:null,height:0,width:0,companyId:null,createdOn:null,status:null,mediaType:mediaType,companyName:null,linkText:null}),vm.fileStackData.spFeature=null,vm.fileStackData.url=data.fileData.url,vm.fileStackData.newTab=!0,vm.fileStackData.subTitle=null,vm.fileStackData.fileStack=!0,vm.fileStackData.client=data.fileData.client,vm.fileStackData.imageUrl="Video"===mediaType?"/sp/resources/images/video-default.png":"IMAGE"===mediaType?data.fileData.url:"/sp/resources/images/media_default.jpg",vm.fileStackMimeType=mediaType,vm.uploadLaterFlag?$timeout(function(){scope.$apply(function(){vm.addInfo.url=vm.fileStackData.url})},200):vm.uploadFile(vm.contextPortraitId,vm.contextCompanyId,vm.fileStackData.url,!1)});vm.uploadFile=function(portraitId,companyId,url,noGrowl){idealPortraitAdminService.uploadAttachment({id:portraitId,companyId:companyId,documentUrl:url}).then(function(response){if(ngDialog.close("ngdialog1"),null===response)return!0;vm.contextPortraitId=null,vm.contextCompanyId=null,vm.fileStackData={},vm.fileStackMimeType="",noGrowl||(vm.getAll(!0,companyId),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.fileUploaded")))})},vm.removeAttachmentPop=function(portraitId,companyId,url){vm.contextPortraitId=portraitId,vm.contextCompanyId=companyId,vm.contextUrl=url,ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.removeDoc,scope:vm})},vm.removeAttachment=function(portraitId,companyId,url){idealPortraitAdminService.removeAttachment({id:portraitId,companyId:companyId,documentUrl:url}).then(function(response){if(ngDialog.close("ngdialog1"),null===response)return!0;vm.contextPortraitId=null,vm.contextCompanyId=null,vm.contextUrl=null,vm.getAll(!0,companyId),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.fileRemoved"))})},vm.startFileUpload=function(portraitId,companyId,uploadLater){vm.contextPortraitId=portraitId,vm.contextCompanyId=companyId,vm.uploadLaterFlag=uploadLater,vm.fileStackData={},vm.fileStackMimeType="",$rootScope.handleFileStack(!0)},vm.getCount=function(id){for(var list=vm.companyPortraitsListMaster,count=0,i=0;i<list.length;i++)if(null!==list[i].companies)for(var cList=list[i].companies,j=0;j<cList.length;j++)cList[j].id===id&&count++;return count},vm.getDetails=function(id){idealPortraitAdminService.get({id:id}).then(function(response){if(null===response)return!0;vm.portraitMatch=angular.copy(response.portraitMatch),vm.lastcategoryPriorityWeightMap={Essential:100*vm.portraitMatch.categoryPriorityWeightMap.Essential,Secondary:100*vm.portraitMatch.categoryPriorityWeightMap.Secondary},createdUserSelectedVariable()})},vm.previewDetail=function(){if(!vm.totalSelected)return!0;ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.preview,scope:vm})},vm.addPortraitPop=function(companyId){vm.companyAddList=[],vm.companyId=companyId,vm.addInfo={};var list=angular.copy(vm.companyPortraitsListMaster);vm.companyAddList=list.filter(function(e){return!e.companies||e.companies&&e.companies.length&&filterByCompany(e.companies,vm.companyId,!1)}),ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.add,scope:vm})},vm.addPortraitConfirm=function(portraitObj,companyObj){ngDialog.closeAll(),vm.addInfo={portraitObj:portraitObj,companyObj:companyObj,url:null},ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.addConfirm,scope:vm})},vm.addPortrait=function(portraitId,companyId){idealPortraitAdminService.assignPortrait({id:portraitId,companyId:companyId}).then(function(response){if(ngDialog.closeAll(),null===response)return!0;null!==vm.addInfo.url&&void 0!==vm.addInfo.url&&""!==vm.addInfo.url&&vm.uploadFile(portraitId,companyId,vm.addInfo.url,!0),vm.getAll(!0,companyId),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.portraitAssigned"))})},vm.removePortraitPop=function(portraitObj,companyId){vm.companyId=companyId,vm.deletePortraitInfo=portraitObj,ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.remove,scope:vm})},vm.removePortrait=function(portraitId,companyId){idealPortraitAdminService.removePortrait({id:portraitId,companyId:companyId}).then(function(response){if(ngDialog.closeAll(),null===response)return!0;vm.getAll(!0,companyId),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.portraitRemoved"))})},vm.closeCompanyPortrait=function(){vm.companyId=null,vm.selectedCompanyObj={},vm.companyPortraitsList=[],vm.companyExistingList=[],vm.companyAddList=[],vm.showCompanyPortraits=!1,vm.fileStackData={},vm.fileStackMimeType="",vm.contextPortraitId=null,vm.contextCompanyId=null,vm.contextUrl=null,vm.attachmentsList=[],vm.pageSetting=angular.copy(vm.originalPageSetting),vm.getCompanies()},vm.viewCompanyPortraits=function(companyObj){vm.companyExistingList=[],vm.selectedCompanyObj=companyObj;var list=angular.copy(vm.companyPortraitsListMaster);vm.companyExistingList=list.filter(function(e){return e.companies&&e.companies.length&&filterByCompany(e.companies,vm.selectedCompanyObj.id,!0)}),vm.showCompanyPortraits=!0},vm.changeTab=function(tabVal){vm.selectedTab!==tabVal&&(vm.selectedTab=tabVal),0===tabVal?(vm.pageSetting=angular.copy(vm.originalPageSetting),vm.getAll()):1===tabVal&&(vm.selectedCompanyObj={},vm.companyPortraitsList=[],vm.showCompanyPortraits=!1,vm.pageSetting=angular.copy(vm.originalPageSetting),vm.getCompanies())},vm.getAll=function(updateCompanyList,companyId){idealPortraitAdminService.getAllIdealPortrait().then(function(response){if(null===response)return!0;if(vm.portraitMatchListing=[],vm.companyPortraitsListMaster=[],vm.portraitMatchListing=response.portraitMatchListing,vm.companyPortraitsListMaster=angular.copy(vm.portraitMatchListing),vm.responseRecieved=!0,updateCompanyList){vm.companyExistingList=[];var list=vm.companyPortraitsListMaster;vm.companyExistingList=list.filter(function(e){return null!==companyId&&null!==e.companies&&filterByCompany(e.companies,companyId,!0)})}})},vm.deletePopup=function(obj){vm.deletePortraitDetails=obj,ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.delete,scope:vm})},vm.deletePortrait=function(obj){idealPortraitAdminService.delete({id:obj.id}).then(function(response){if(ngDialog.close("ngdialog1"),null===response)return!0;for(var i=0;i<vm.portraitMatchListing.length;i++)if(obj.id===vm.portraitMatchListing[i].id){vm.portraitMatchListing.splice(i,1),vm.deletePortraitDetails=null,vm.init();break}sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.portraitDeleted"))})},vm.infinteScroll=function(pageSize,type){switch(type){case"idealPortraits":if(!vm.portraitMatchListing.length)return!0;vm.pageSetting.disabledInfinite||(vm.pageSetting.pageSize=pageSize,pageSize>=vm.portraitMatchListing.length&&(vm.pageSetting.pageSize=vm.portraitMatchListing.length));break;case"companyList":if(!vm.portraitMatchCompanies.length)return!0;vm.pageSetting.disabledInfinite||(vm.pageSetting.pageSize=pageSize,pageSize>=vm.portraitMatchCompanies.length&&(vm.pageSetting.pageSize=vm.portraitMatchCompanies.length));break;case"companyPortraits":if(!vm.companyPortraitsListMaster.length)return!0;vm.pageSetting.disabledInfinite||(vm.pageSetting.pageSize=pageSize,pageSize>=vm.companyPortraitsListMaster.length&&(vm.pageSetting.pageSize=vm.companyPortraitsListMaster.length));break;default:if(!vm.portraitMatchListing.length)return!0;vm.pageSetting.disabledInfinite||(vm.pageSetting.pageSize=pageSize,pageSize>=vm.portraitMatchListing.length&&(vm.pageSetting.pageSize=vm.portraitMatchListing.length))}},vm.getCompanyNames=function(obj){var namesList=[],remainingList=[],masterList=[],remainingListCount=0;if(null!==obj){masterList=obj.map(function(e){return e.name}),masterList.sort(function(a,b){var af=a.toLowerCase(),bf=b.toLowerCase();return af===bf?0:+(af>bf)||-1});namesList=angular.copy(masterList).splice(0,4),masterList.length>4&&(remainingList=angular.copy(masterList),remainingListCount=masterList.length-4)}return{namesList:namesList,remainingList:remainingList,remainingListCount:remainingListCount}},vm.getCompanies=function(){idealPortraitAdminService.getCompanies().then(function(response){if(null===response)return!0;vm.portraitMatchCompanies=response.portraitMatchCompanies})},vm.init=function(){vm.changeTab(0)},vm.init()}}}]);