angular.module("spApp").directive("idealPortraits",["spConfig","sharedProperties","spValue","$q","$rootScope","$state","idealPortraitService","memberService","ngDialog","$localStorage","rolesService","groupsService","$timeout",function(spConfig,sharedProperties,spValue,$q,$rootScope,$state,idealPortraitService,memberService,ngDialog,$localStorage,rolesService,groupsService,$timeout){return{restrict:"EA",replace:!0,templateUrl:function(element,attrs){return"/sp/resources/html/people-analytics/view/"+attrs.urlSrc},link:function(scope,element,attrs){function prepareMatchByTalentData(){if(!self.masterMemberList.length&&!self.masterGroupsList.length){var matchTalent={};memberService.getAllMembers().then(function(response){self.masterMemberList=response,groupsService.getGroup().then(function(response){self.masterGroupsList=response;for(var i=0;i<self.masterMemberList.length;i++)matchTalent={},matchTalent.id=self.masterMemberList[i].id,matchTalent.name=self.masterMemberList[i].firstName+" "+self.masterMemberList[i].lastName,matchTalent.type="users",self.masterMatchTalentList.push(matchTalent);for(var j=0;j<self.masterGroupsList.length;j++)self.masterGroupsList[j].count>0&&(matchTalent={},matchTalent.id=self.masterGroupsList[j].id,matchTalent.name=self.masterGroupsList[j].name,matchTalent.type="groups",self.masterMatchTalentList.push(matchTalent));self.matchTalentList=angular.copy(self.masterMatchTalentList)})})}}function clearMatchByTalentData(){self.matchTalentList=[],self.matchTalentList=angular.copy(self.masterMatchTalentList),self.selectedMatchList=[],self.groupIdsList=[],self.userIdsList=[]}function init(){$localStorage.remove("activeView"),null!==$localStorage.get("portraitRequest")&&sharedProperties.growlMessage($rootScope.pullInterNationalization("manageAccountContent.requestSubmit")),$localStorage.remove("portraitRequest"),idealPortraitService.getAll().then(function(response){if(null===response)return!0;self.portraitMatchListing=response,self.responseAvailable=!0}),null!==sharedProperties.getParam("pId")&&""!==sharedProperties.getParam("pId")&&$localStorage.set("portraitId",sharedProperties.getParam("pId")),null!==$localStorage.get("portraitId")?self.comparePortrait($localStorage.get("portraitId")):(self.activeView="portrait-listing",$state.go("portrait-listing")),self.showRequestFlag=!0}var self=scope;self.portraitMatchListing=[],self.responseAvailable=!1,self.selectedPortraitId=null,self.selectedPortrait={},self.selectedRoleId=null,self.selectedRole={},self.selectedUserPortrait={},self.activeView="",self.roleList=[],self.addRolesCollector={existingRole:[],newRole:[]},self.viewAllFlag=!1,self.pageView="portraitDetail",self.portraitUsers=[],self.sort="plus",self.masterMemberList=[],self.masterGroupsList=[],self.masterMatchTalentList=[],self.matchTalentList=[],self.selectedMatchList=[],self.groupIdsList=[],self.userIdsList=[],self.attachmentObj={url:null,name:null,type:null},self.showRequestFlag=!0,self.memberSearchText="",self.userInfo=$localStorage.get("loggegdInProfile"),self.currentPageUrl=window.location.href,self.portraitComment="",self.contentSetting={updateSearchText:""},self.updateSearchVal=function(searchTxt){self.contentSetting.updateSearchText=void 0!==searchTxt&&""!==searchTxt?window.escape(searchTxt):""},self.resetUpdatedSearchVal=function(){self.contentSetting.updateSearchText=""},self.comparePortrait=function(id){null===id||void 0===id?($localStorage.remove("portraitId"),init()):(clearMatchByTalentData(),self.selectedPortraitId=id,idealPortraitService.get(self.selectedPortraitId).then(function(response){null===response||void 0===response?(sharedProperties.growlMessage($rootScope.pullInterNationalization("portrait.accessError"),"","glyphicon glyphicon-ban-circle"),$localStorage.remove("portraitId"),$timeout(function(){window.location.reload()},2e3)):(self.selectedRoleId=null,self.selectedRole={},self.pageView="portraitDetail",self.selectedPortrait=response.portraitMatch,prepareMatchByTalentData(),self.activeView="portrait-compare",self.showRequestFlag=!1,null===$localStorage.get("portraitId")?($state.transitionTo("portrait-compare"),$("html,body").animate({scrollTop:$(".header-info-container").offset().top-40},1e3)):$state.go("portrait-compare"),$localStorage.set("portraitId",self.selectedPortraitId),sharedProperties.fireAnalyticsEvent("PA | View Portrait Details","N/A"))}))},self.addToMatchList=function(obj){"groups"===obj.originalObject.type?self.groupIdsList.push(obj.originalObject.id):self.userIdsList.push(obj.originalObject.id),self.selectedMatchList.push(obj.originalObject),sharedProperties.spilceIndexWithBreak(self.matchTalentList,"id",obj.originalObject.id),self.selectedRoleId=null,self.pageView="portraitDetail"},self.removeFromMatchList=function(obj){"groups"===obj.type?self.groupIdsList.splice(self.groupIdsList.indexOf(obj.id),1):self.userIdsList.splice(self.userIdsList.indexOf(obj.id),1),sharedProperties.spilceIndexWithBreak(self.selectedMatchList,"id",obj.id),self.matchTalentList.push(obj),self.selectedRoleId=null,self.pageView="portraitDetail"},self.matchPortrait=function(){idealPortraitService.matchPortrait({id:self.selectedPortraitId,userIds:self.userIdsList.join(),groupIds:self.groupIdsList.join()}).then(function(response){if(null===response||void 0===response)sharedProperties.growlMessage($rootScope.pullInterNationalization("portrait.accessError"),"","glyphicon glyphicon-ban-circle"),$localStorage.remove("portraitId"),$timeout(function(){window.location.reload()},2e3);else{if(self.selectedRoleId=null,self.portraitUsers=[],void 0!==response.portraitMatch.users&&response.portraitMatch.users.length)for(var i=0;i<response.portraitMatch.users.length;i++)null!==response.portraitMatch.users[i].matchResult&&self.portraitUsers.push(response.portraitMatch.users[i]);self.pageView="portraitUsers",$("html,body").animate({scrollTop:$(".header-info-container").offset().top-40},1e3),sharedProperties.fireAnalyticsEvent("PA | Match Portrait by Talent","N/A")}})},self.initAddRole=function(){self.submitError=!1,self.loadCreateRole=!0,self.formSubmit=!1,self.newRole={form:{},details:{description:"",portraitId:""}}},self.createNewRole=function(isUpdate,isAdded){self.formSubmit=!1,self.submitError=!1,self.newRole.form.$valid?rolesService.createRole(self.newRole.details,isUpdate).then(function(response){if("true"===response.Success)self.addRoleCall(response.hiringRole),void 0!==spValue.getAllRoles.hiringRoleListing&&spValue.getAllRoles.hiringRoleListing.unshift(response.hiringRole),self.roleList.push({id:response.hiringRole.id,name:response.hiringRole.name}),ngDialog.close("ngdialog1"),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.roleCreated")),sharedProperties.fireAnalyticsEvent("PA | Ideal Portrait Role Created","N/A");else{var errorMessage="";for(var key in response.error)errorMessage=response.error[key];self.submitError=errorMessage}}):self.formSubmit=!0},self.switchType=function(type){if(self.addRolesCollector.active===type)return!0;self.addRolesCollector.active=type},self.viewAllRoles=function(id,roles){self.selectedPortraitId=id,self.viewAllFlag=!0;for(var i=0,existingRoles=[];i<roles.length;i++)existingRoles.push(roles[i]);self.addRolesCollector={existing:existingRoles,roleSearch:"",roleLeft:self.roleList,types:["add","create","viewAll"],active:"viewAll"},sharedProperties.fireAnalyticsEvent("PA | Ideal Portrait view all Roles","N/A"),ngDialog.open({template:spConfig.talentAnalytics.memberService.dialog.addRolePortrait,scope:self}).closePromise.then(function(data){self.viewAllFlag=!1})},self.addRole=function(id,roles,active){self.resetUpdatedSearchVal(),self.selectedPortraitId=id,rolesService.getRolesWithoutPortrait().then(function(response){self.roleList=response.hiringRoleList;for(var i=0,existingRoles=[];i<roles.length;i++)existingRoles.push(roles[i].id);self.addRolesCollector={existing:existingRoles,roleSearch:"",roleLeft:self.roleList,types:["add","create","viewAll"],active:"add"},void 0!==active&&(self.addRolesCollector.active=active),ngDialog.open({template:spConfig.talentAnalytics.memberService.dialog.addRolePortrait,scope:self})})},self.addRoleCall=function(roleObj){rolesService.assignPortrait({id:roleObj.id,portraitId:self.selectedPortraitId,addPrism:!1}).then(function(response){if(null===response||void 0===response)sharedProperties.growlMessage($rootScope.pullInterNationalization("portrait.accessError"),"","glyphicon glyphicon-ban-circle"),$timeout(function(){window.location.href=spConfig.talentAnalytics.idealPortrait.homePage},2e3);else{for(var i=0;i<self.portraitMatchListing.length;i++)if(self.portraitMatchListing[i].id===self.selectedPortraitId){self.portraitMatchListing[i].roles.push(roleObj);break}self.addRolesCollector.existing.push(roleObj.id),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.roleAddedToPortrait")),sharedProperties.fireAnalyticsEvent("PA | Ideal Portrait Role added","N/A")}})},self.removeRoleModal=function(id,roleObj){self.selectedPortraitId=id,self.selectedRole=roleObj,ngDialog.open({template:spConfig.talentAnalytics.idealPortrait.dialog.removeRole,scope:self})},self.removeRoleCall=function(roleObj){rolesService.removePortrait({id:roleObj.id,portraitId:self.selectedPortraitId,addPrism:!1}).then(function(response){if(null===response||void 0===response)sharedProperties.growlMessage($rootScope.pullInterNationalization("portrait.accessError"),"","glyphicon glyphicon-ban-circle"),$timeout(function(){window.location.href=spConfig.talentAnalytics.idealPortrait.homePage},2e3);else{for(var j=0;j<self.portraitMatchListing.length;j++)if(self.portraitMatchListing[j].id===self.selectedPortraitId)for(var k=0;k<self.portraitMatchListing[j].roles.length;k++)if(self.portraitMatchListing[j].roles[k].id===roleObj.id){self.portraitMatchListing[j].roles.splice(k,1),void 0!==self.addRolesCollector.existing&&self.addRolesCollector.existing.length&&self.addRolesCollector.existing.splice(k,1);break}ngDialog.close(),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.roleRemovedFromPortrait")),sharedProperties.fireAnalyticsEvent("PA | Ideal Portrait Role removed","N/A")}})},self.closeNewRoleView=function(){ngDialog.close("ngdialog1")},self.closeReportView=function(type){self.selectedUserPortrait="","users"===type?self.pageView="portraitUsers":(clearMatchByTalentData(),self.selectedRoleId=null,self.pageView="portraitDetail")},self.matchByRole=function(roleObj){self.selectedRoleId!==roleObj.id&&(clearMatchByTalentData(),self.selectedRoleId=roleObj.id,self.selectedRole=roleObj,self.portraitUsers=[],rolesService.get({id:self.selectedRoleId}).then(function(response){if(null===response||void 0===response||null===response.hiringRole.portrait)sharedProperties.growlMessage($rootScope.pullInterNationalization("portrait.accessError"),"","glyphicon glyphicon-ban-circle"),$localStorage.remove("portraitId"),$timeout(function(){window.location.reload()},2e3);else{if(void 0!==response.hiringRole.users&&response.hiringRole.users.length)for(var i=0;i<response.hiringRole.users.length;i++)null!==response.hiringRole.users[i].matchResult&&self.portraitUsers.push(response.hiringRole.users[i]);self.selectedRole.description=response.hiringRole.description,self.pageView="portraitUsers",$("html,body").animate({scrollTop:$(".header-info-container").offset().top-40},1e3),sharedProperties.fireAnalyticsEvent("PA | Match Portrait by Role","N/A")}}))},self.viewUserReport=function(userObj){self.pageView="portraitUsersReport",self.selectedUserPortrait=userObj,$("html,body").animate({scrollTop:$(".header-info-container").offset().top-40},1e3),sharedProperties.fireAnalyticsEvent("PA | Ideal Portrait View Report","N/A")},self.viewRoleModal=function(){sharedProperties.fireAnalyticsEvent("PA | View Ideal Portrait Role Pop","N/A"),ngDialog.open({template:spConfig.talentAnalytics.idealPortrait.dialog.rolePreview,scope:self})},self.orderBy=function(sort){for(var i=0;i<self.portraitUsers.length;i++)self.portraitUsers.sort(function(a,b){var an=null!==a.matchResult?a.matchResult.matchPercent:0,bn=null!==b.matchResult?b.matchResult.matchPercent:0,af=a.firstName,bf=b.firstName;switch(sort){case"plus":return an===bn?af===bf?0:+(af>bf)||-1:+(bn>an)||-1;case"minus":return an===bn?af===bf?0:+(af>bf)||-1:+(an>bn)||-1}})},self.requestNewPortraitModal=function(){self.removeAttachment(),self.portraitComment="",ngDialog.open({template:spConfig.talentAnalytics.idealPortrait.dialog.requestNewPortrait,scope:self})},self.openFileStack=function(){$(".ngdialog").hide(),$rootScope.handleFileStack(!0)},self.requestNewPortrait=function(e){null!==self.attachmentObj.url&&""!==this.portraitComment?(ngDialog.close(),$localStorage.set("portraitRequest","true"),sharedProperties.fireAnalyticsEvent("PA | Request new portrait","N/A")):e.preventDefault()};scope.$on("fileStackSuccessNotes",function(e,data){if($(".ngdialog").show(),null===data)return!0;scope.$apply(function(){self.attachmentObj.url=data.fileData.url,self.attachmentObj.name=data.fileData.filename,self.attachmentObj.type=sharedProperties.mapMediaType(data.fileData.mimetype)})});self.removeAttachment=function(){self.attachmentObj={url:null,name:null,type:null}},self.openDocument=function(url){window.open(url,"_blank").focus()},init()}}}]);