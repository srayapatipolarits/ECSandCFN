angular.module("spApp").directive("paDashboardSetting",["spConfig","sharedProperties","commonService","spValue","ngDialog","$filter","$localStorage","$q","$timeout","$rootScope","paDashboardService","$state","filterFilter",function(spConfig,sharedProperties,commonService,spValue,ngDialog,$filter,$localStorage,$q,$timeout,$rootScope,paDashboardService,$state,filterFilter){return{restrict:"EA",replace:!0,templateUrl:function(element,attrs){return"/sp/resources/html/sysAdmin/peopleAnalytics/dashboard/"+attrs.urlSrc},link:function(scope,element,attrs){function init(){paDashboardService.getAll().then(function(response){if(void 0!==response.hiringDashboardListing&&response.hiringDashboardListing.length){self.activeId=response.hiringDashboardListing[0].id,self.addedArticles=response.hiringDashboardListing[0].articles,self.updatedBy=response.hiringDashboardListing[0].updatedBy,self.updatedOn=response.hiringDashboardListing[0].updatedOn,self.mediaSettings=response.hiringDashboardListing[0].images;for(var i=0;i<self.addedArticles.length;i++)self.articleIds.push(self.addedArticles[i].articleLinkUrl)}}),$state.go("paDashboard")}var self=scope;self.responseAvailable=!1,self.responseAvailableForModal=!1,self.viewMode={articles:!0,images:!1},self.masterArticlesList=[],self.addedArticles=[],self.articlesList=[],self.articleIds=[],self.initializeBool=!1,self.paArticleText="",self.mediaSettings={RelationShipAdvisor:null,Spectrum:null,Hiring:null},self.updatedBy=null,self.updatedOn=null,self.activeId=null,self.toggleView=function(){self.viewMode.articles=!self.viewMode.articles,self.viewMode.images=!self.viewMode.images},self.selectArticleModal=function(){ngDialog.open({template:spConfig.admin.talentAnalytics.dashboard.dialog.selectArticle,scope:self}).closePromise.then(function(data){self.paArticleText="",self.articlesList=[]})},self.getAllArticles=function(text){self.paArticleText=text,!self.masterArticlesList.length&&self.paArticleText.length>2?($rootScope.$broadcast("httpLoaderStart"),paDashboardService.getAllArticles().then(function(response){self.responseAvailableForModal=!0,self.masterArticlesList=response.articles;for(var i=0;i<self.masterArticlesList.length;i++){self.masterArticlesList[i].added=!1;for(var j=0;j<self.addedArticles.length;j++)self.masterArticlesList[i].articleLinkUrl===self.addedArticles[j].articleLinkUrl&&(self.masterArticlesList[i].added=!0)}self.articlesList=filterFilter(self.masterArticlesList,self.paArticleText),$rootScope.$broadcast("httpLoaderEnd")})):self.paArticleText.length>2?self.articlesList=filterFilter(self.masterArticlesList,self.paArticleText):self.articlesList=[]},self.clearArticleSearch=function(){self.articlesList=[],self.paArticleText=""},self.removeArticle=function(id){sharedProperties.spilceIndexWithBreak(self.addedArticles,"articleLinkUrl",id);var filteredArray=self.articleIds.filter(function(e){return e!==id});self.articleIds=angular.copy(filteredArray);for(var i=0;i<self.masterArticlesList.length;i++)if(self.masterArticlesList[i].articleLinkUrl===id){self.masterArticlesList[i].added=!1;break}},self.addArticle=function(obj){if(-1===self.addedArticles.indexOf(obj.articleLinkUrl)){self.addedArticles.push(obj),self.articleIds.push(obj.articleLinkUrl);for(var i=0;i<self.masterArticlesList.length;i++)if(self.masterArticlesList[i].articleLinkUrl===obj.articleLinkUrl){self.masterArticlesList[i].added=!0;break}self.articlesList=filterFilter(self.masterArticlesList,self.paArticleText)}else sharedProperties.growlMessage("Article already added.","<strong> Alert </strong>","glyphicon glyphicon-ban-circle")},self.articlesSortable=function(length){if(!self.initializeBool&&length>1){new Sortable(document.getElementById("sort-me"),{animation:150,ghostClass:"ghost",handle:".dHandle",yAxisOnly:!0,onEnd:function(evt){self.addedArticles.move(evt.oldIndex,evt.newIndex),self.articleIds.move(evt.oldIndex,evt.newIndex)}});self.initializeBool=!0}},self.saveSettings=function(){var data={mediaSettings:self.mediaSettings,artilces:self.articleIds};paDashboardService.saveSettings(data).then(function(response){sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.pa.admin.dashboard.save")),self.activeId=response.hiringDashboard.id,self.updatedBy=response.hiringDashboard.updatedBy,self.updatedOn=response.hiringDashboard.updatedOn})},self.updateSettings=function(){var data={id:self.activeId,mediaSettings:self.mediaSettings,artilces:self.articleIds};paDashboardService.updateSettings(data).then(function(response){sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.pa.admin.dashboard.update")),self.updatedBy=response.hiringDashboard.updatedBy,self.updatedOn=response.hiringDashboard.updatedOn})},self.cancelSave=function(){window.location.reload()},self.selectBackground=function(type){$rootScope.showMediaManager=!0;var destroyRoot=scope.$on("mediaData",function(e,data){if(destroyRoot(),null===data)return!0;switch(type){case"RA":self.mediaSettings.RelationShipAdvisor=data.url;break;case"Spectrum":self.mediaSettings.Spectrum=data.url;break;case"PP":self.mediaSettings.Hiring=data.url}})},init()}}}]);