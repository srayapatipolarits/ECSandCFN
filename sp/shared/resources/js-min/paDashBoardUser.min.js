angular.module("spApp").directive("paDashboard",["spConfig","sharedProperties","spValue","paDashBoardUser","rolesService","ngDialog","$rootScope","$localStorage","basicService","$sce","$timeout","idealPortraitService",function(spConfig,sharedProperties,spValue,paDashBoardUser,rolesService,ngDialog,$rootScope,$localStorage,basicService,$sce,$timeout,idealPortraitService){return{restrict:"E",templateUrl:function(element,attrs){return"/sp/resources/html/people-analytics/view/dashboard.html"},link:function(scope,element,attrs){function getDashboardSettingsDetail(){paDashBoardUser.getDashboardSettingsDetail().then(function(response){if(null===response)return vm.errorState.dashboardSettingsDetail=!0,!0;vm.pageRelatedData.dashboardSettingsDetail=response.dashboardSettings})}function getEmployeeCandidateStats(){paDashBoardUser.getEmployeeCandidateStats().then(function(response){if(null===response)return vm.errorState.employeeCandidateStats=!0,!0;vm.pageRelatedData.employeeCandidateStats=response})}function init(){$localStorage.remove("activeView","mName","portraitId"),getEmployeeCandidateStats(),getDashboardSettingsDetail(),idealPortraitService.getAll().then(function(response){if(null===response)return!0;vm.portraitsListing=response})}var vm=scope;vm.pageReady=!1,vm.errorState={employeeCandidateStats:!1,dashboardSettingsDetail:!1},vm.pageRelatedData={visited:basicService.getUserInfo().paVisited,employeeCandidateStats:[],dashboardSettingsDetail:null},vm.pageSetting={textSearching:"",updateSearchText:""},vm.image={relationShip:spConfig.talentAnalytics.images.relationShip,spectrum:spConfig.talentAnalytics.images.spectrum,idealPortrait:spConfig.talentAnalytics.images.idealPortrait},vm.videoType="",vm.videoUrl=null,vm.portraitsListing=[],vm.userInfo=$localStorage.get("loggegdInProfile"),vm.updateSearchVal=function(searchTxt){vm.pageSetting.updateSearchText=void 0!==searchTxt&&""!==searchTxt?window.escape(searchTxt):""},vm.resetUpdatedSearchVal=function(){vm.pageSetting.updateSearchText=""},vm.employeeCandidateStats=[],vm.showNewRoleView=function(){vm.initAddRole();ngDialog.open({template:spConfig.talentAnalytics.roles.dialog.createRole,scope:vm})},vm.prepareVideo=function(videoSrc){if(/youtube/g.test(videoSrc)){vm.videoType="youtube";var youtubeId=parseYouTube(videoSrc);vm.videoUrl=$sce.trustAsResourceUrl("https://www.youtube.com/embed/"+youtubeId+"?autoplay=0&rel=0&autohide=1&showinfo=0&wmode=transparent&modestbranding=1&iv_load_policy=3&vq=large")}else if(/vimeo/g.test(videoSrc)){vm.videoType="vimeo";var vimeoId=parseVimeo(videoSrc),userLocale=sharedProperties.provideVendorSpecificLocale("vimeo"),options={id:vimeoId,width:630,height:354};$timeout(function(){new Vimeo.Player("vimeoPlayer",options).enableTextTrack(userLocale).then(function(track){track.language=userLocale,track.kind="captions"})},500)}else vm.videoType="html5",vm.videoUrl=$sce.trustAsResourceUrl(videoSrc)};var parseYouTube=function(url){var p=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return!!url.match(p)&&RegExp.$1},parseVimeo=function(url){var m=url.match(/^.+vimeo.com\/(.*\/)?([^#\?]*)/);return m?m[2]||m[1]:null};vm.initAddRole=function(){vm.submitError=!1,vm.loadCreateRole=!0,vm.formSubmit=!1,vm.newRole={form:{},details:{description:"",portraitId:""}}},vm.createNewRole=function(isUpdate,isAdded){if(vm.formSubmit=!1,vm.submitError=!1,vm.newRole.form.$valid){if(""!==vm.newRole.details.portraitId&&void 0!==vm.newRole.details.portraitId.originalObject){var oldPortraitObject=angular.copy(vm.newRole.details.portraitId);vm.newRole.details.portraitId=vm.newRole.details.portraitId.originalObject.id}rolesService.createRole(vm.newRole.details,isUpdate).then(function(response){if("true"===response.Success)getEmployeeCandidateStats(),ngDialog.close("ngdialog1"),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.roleCreated")),sharedProperties.fireAnalyticsEvent("PA | Create new Role from Dashboard","N/A");else{var errorMessage="";for(var key in response.error)errorMessage=response.error[key];vm.submitError=errorMessage,vm.newRole.details.portraitId=angular.copy(oldPortraitObject)}})}else vm.formSubmit=!0},vm.clearPortraitInputBox=function(){$(".autoCompleteCss").val(""),vm.newRole.details.portraitId=""},vm.closeNewRoleView=function(){ngDialog.close("ngdialog1")},vm.openArticle=function(articleUrl){paDashBoardUser.articleDetail(articleUrl).then(function(response){vm.articlePageDetails=response.article,void 0!==response.article.videoUrl&&null!==response.article.videoUrl&&"VIDEO"===response.article.articleType?(vm.articleVideo=response.article.videoUrl,vm.prepareVideo(vm.articleVideo),vm.videoAvailable=!0):(vm.videoType="",vm.videoAvailable=!1),sharedProperties.fireAnalyticsEvent("PA | View Article from Dashboard",articleUrl),ngDialog.open({template:spConfig.talentAnalytics.dashboard.dialog.knowledge,scope:vm})})},vm.visitedDashboard=function(){paDashBoardUser.visitedDashboard().then(function(response){if(null===response)return!0;vm.pageRelatedData.visited=!0,$localStorage.remove("loggegdInProfile")})},vm.redirectToPage=function(url){sharedProperties.fireAnalyticsEvent("PA | Redirect From Dashboard",url),window.location.href=url},init()}}}]),angular.module("spApp").directive("memberRedirect",["spConfig","$rootScope","ajaxService","sharedProperties","$q","basicService","memberService","$localStorage",function(spConfig,$rootScope,ajaxService,sharedProperties,$q,basicService,memberService,$localStorage){return{restrict:"E",templateUrl:function(element,attrs){return spConfig.talentAnalytics.dashboard.search},link:function(scope,element,attrs){function relationShipAdvisorPage(withs){void 0!==withs?($localStorage.set("empUserId",vm.groups.originalObject.id).set("mName",vm.groups.originalObject.firstName+" "+vm.groups.originalObject.lastName),sharedProperties.fireAnalyticsEvent("PA | View User Detail From Dashboard","N/A"),window.location.href="/sp/pa/tools#/memberDetail?email="+withs):window.location.href="/sp/pa/tools"}function localSearch(query,list,callback){list.length?processRequest(query,list,callback):memberService.getAllMembers(!1).then(function(response){if(null===response)return!0;vm.list=response,processRequest(query,response,callback)})}function processRequest(query,list,callback){for(var matches=[],i=0;i<list.length&&matches.length<5;i++)!list[i].firstName||-1===list[i].firstName.toLowerCase().indexOf(query.searchStr.toLowerCase())&&-1===list[i].lastName.toLowerCase().indexOf(query.searchStr.toLowerCase())&&-1===list[i].email.toLowerCase().indexOf(query.searchStr.toLowerCase())||matches.push(list[i]);callback&&callback(matches)}var vm=scope;vm.list=[],vm.groups={},vm.localSearch=localSearch,vm.relationShipAdvisorPage=relationShipAdvisorPage}}}]);