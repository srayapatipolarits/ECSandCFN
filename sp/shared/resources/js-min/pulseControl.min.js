angular.module("spApp").directive("pulseControl",["ngDialog","sharedProperties","$rootScope","ajaxService","$compile","$localStorage","$timeout",function(ngDialog,sharedProperties,$rootScope,ajaxService,$compile,$localStorage,$timeout){return{restrict:"E",templateUrl:function(element,attrs){return"/sp/resources/html/sysAdmin/pulse/"+attrs.urlSrc},link:function(scope,element,attrs){function languageOperation(){vm.otherLanguages=[],vm.languageSet=vm.masterLanguageSet.filter(function(e){return-1===vm.pulseDetail.locales.indexOf(e)});var otherLanguages=angular.copy(vm.pulseDetail.locales),index=otherLanguages.indexOf(vm.pulseDetail.masterLocale);-1!==index&&otherLanguages.splice(index,1),vm.otherLanguages=otherLanguages}function mapObject(edit){var sorted=angular.copy(vm.getPreviewDetail.questionCategories);if(vm.getPreviewDetail.questionCategories.filter(function(e,index){var breaking=[];vm.totalBreak[e.uid]=[];for(var i=0;i<e.questions.length;i++)if(sorted[index].questions[i+breaking.length].index=i+1,e.questions[i].displayKey){var idx=parseInt(e.questions[i].displayKey,10)+breaking.length;vm.totalBreak[e.uid].push(parseInt(e.questions[i].displayKey)),void 0!==edit&&(sorted[index].questions.splice(idx,0,{pageBreak:!0,uid:"pageBreak"+Math.random(),idx:idx,key:i}),breaking.push(breaking.length))}}),void 0===edit){vm.totoalNumberOfRecord=0;for(var key in vm.totalBreak){var length=vm.totalBreak[key].length+1;vm.totoalNumberOfRecord=vm.totoalNumberOfRecord+length}}vm.getPreviewDetail.questionCategories=angular.copy(sorted)}function setView(scopes){vm.masterGetPreviewDetail.questionCategories[vm.defaultPulseName].questions.length-($(".handle").length+3)>=0?(vm.addPageVisible=!0,void 0===scopes&&vm.$apply(function(){vm.addPageVisible=!0})):(vm.addPageVisible=!1,void 0===scopes&&vm.$apply(function(){vm.addPageVisible=!1}))}var vm=scope,mode=attrs.displayMode,ids=sharedProperties.getParam("viewable");vm.serviceApis={createPulseFile:"/sp/sysAdmin/pulse/createPulseFile",createPulse:"/sp/sysAdmin/pulse/createPulse",getDetails:"/sp/sysAdmin/pulse/getDetails",updatePulse:"/sp/sysAdmin/pulse/update",getPreview:"/sp/sysAdmin/pulse/getPreview",addPulseQuestions:"/sp/sysAdmin/pulse/addPulseQuestions",removePulseQuestions:"/sp/sysAdmin/pulse/removePulseQuestions",updatePulseQuestions:"/sp/sysAdmin/pulse/updatePulseQuestions"},vm.modalUrl={removePulse:"/sp/resources/html/sysAdmin/pulse/dialog/remove-file.html"},vm.csvFile=null,vm.error={pulseSubmitted:!1,updatePulseSubmitted:!1,duplicate:!1},vm.pulse={name:null,description:null,locale:"en_US"},vm.pagination={start:0,end:0},vm.masterLanguageSet=["en_US","es_LA"],vm.languageSet=angular.copy(vm.masterLanguageSet),vm.enableLanguage=!1,vm.createdFile=null,vm.triggeredRequest=null;var practiceAreaSortVar=null;vm.addPageVisible=!1,vm.pulseDetail=null,vm.preview=!1,vm.questionEdit=!1,vm.getPreviewDetail=null,vm.masterGetPreviewDetail=null,vm.defaultPulseName=0,vm.otherLanguages=[],vm.totalBreak={},vm.numberOfRecord=0,vm.totoalNumberOfRecord=0,vm.attachEvent=function(){$("body").on("change",".mediaFormUpload",vm.uploadJSON)},vm.uploadJSON=function(evt){var multiPartRequest=null;vm.csvFile=null;var formObj=new FormData,currentFile=evt.target.files[0];formObj.append("pulseQuestions",currentFile,currentFile.name),multiPartRequest=$.ajax({url:vm.serviceApis.createPulseFile,type:"POST",data:formObj,processData:!1,contentType:!1,beforeSend:function(){$rootScope.$broadcast("httpLoaderStart")}}),multiPartRequest.done(function(response){null!==response.success&&"true"===response.success.Success?(sharedProperties.growlMessage($rootScope.pullInterNationalization("mediaManager.growlMessage.success")),vm.createdFile=response.success.pulseQuestion,vm.enableLanguage&&vm.addPulseQuestions({pulseQuestionSetId:ids,locale:vm.createdFile.locale}),scope.$apply(function(){vm.csvFile=currentFile,"edit"===mode&&vm.getDetails(ids)}),evt.currentTarget.value="",$rootScope.$broadcast("httpLoaderEnd")):(sharedProperties.ajaxError(response.error),evt.currentTarget.value="",scope.$apply(function(){vm.csvFile=null}),$rootScope.$broadcast("httpLoaderEnd"))}),multiPartRequest.fail(function(jqXHR,textStatus){sharedProperties.growlMessage($rootScope.pullInterNationalization("mediaManager.growlMessage.fail"),"<strong> Alert </strong>","glyphicon glyphicon-ban-circle"),evt.currentTarget.value="",$rootScope.$broadcast("httpLoaderEnd")})},vm.createPulse=function(){vm.error.pulseSubmitted=!1,this.pulseControl.$valid&&null!==vm.csvFile?ajaxService.getAjaxResponse({url:vm.serviceApis.createPulse,data:$.param(vm.pulse)}).then(function(response){"true"===response.Success?(sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.create.success")),$timeout(vm.returnToList,1e3)):null!=response.error&&sharedProperties.ajaxError(response.error)}):vm.error.pulseSubmitted=!0},vm.updatePulse=function(){vm.error.pulseSubmitted=!1,this.pulseControl.$valid?ajaxService.getAjaxResponse({url:vm.serviceApis.updatePulse,data:$.param({pulseQuestionSetId:ids,name:vm.pulseDetail.name,description:vm.pulseDetail.description})}).then(function(response){"true"===response.Success?(sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.edit.success")),window.location.reload()):null!=response.error&&sharedProperties.ajaxError(response.error)}):vm.error.pulseSubmitted=!0},vm.returnToList=function(){window.location.href="/sp/sysAdmin/pulse/list"},vm.getDetails=function(id){null===id&&vm.returnToList(),ajaxService.getAjaxResponse({url:vm.serviceApis.getDetails,data:$.param({pulseQuestionSetId:id})}).then(function(response){"true"===response.Success?(vm.pulseDetail=response.pulseQuestion,languageOperation()):null!=response.error&&sharedProperties.ajaxError(response.error)})},vm.getPreview=function(param,edit){ajaxService.getAjaxResponse({url:vm.serviceApis.getPreview,data:$.param(param)}).then(function(response){"true"===response.Success?(vm.masterGetPreviewDetail=response.pulseQuestion,vm.getPreviewDetail=angular.copy(response.pulseQuestion),vm.defaultPulseName=0,vm.numberOfRecord=0,vm.error.updatePulseSubmitted=!1,mapObject(edit),setView("noScope"),vm.preview=void 0===edit,vm.questionEdit=void 0!==edit):null!=response.error&&sharedProperties.ajaxError(response.error)})},vm.addPageBreak=function(question){setView("noScope"),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.push({pageBreak:!0,uid:"pageBreak"+Math.random(),idx:vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.length,key:vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.length})},vm.closePreview=function(){practiceAreaSortVar=null,vm.getPreviewDetail=null,vm.defaultPulseName=0,vm.numberOfRecord=0,vm.preview=!1,vm.questionEdit=!1,vm.pagination={start:0,end:0},vm.totalBreak={}},vm.increment=function(validate){if(void 0!==validate)return vm.error.updatePulseSubmitted=!1,this.updatePulseQuestion.$valid?(vm.defaultPulseName++,vm.numberOfRecord++,vm.pagination={start:0,end:0},!0):(vm.error.updatePulseSubmitted=!0,!0);vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].length>vm.pagination.end?(vm.pagination.end++,vm.numberOfRecord++,vm.pagination.end&&(vm.pagination.start=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid][vm.pagination.end-1])):vm.defaultPulseName<vm.getPreviewDetail.questionCategories.length-1&&(vm.defaultPulseName++,vm.numberOfRecord++,vm.pagination={start:0,end:0}),$("html,body").animate({scrollTop:$(".pulse-question-list-checkbox").offset().top-20},300)},vm.decrement=function(validate){if(void 0!==validate)return vm.error.updatePulseSubmitted=!1,this.updatePulseQuestion.$valid?(vm.defaultPulseName--,vm.numberOfRecord--,vm.pagination={start:0,end:0},!0):(vm.error.updatePulseSubmitted=!0,!0);0!==vm.pagination.end?(vm.pagination.end--,vm.numberOfRecord--,vm.pagination.start=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid][vm.pagination.end-1]):vm.defaultPulseName>0&&(vm.defaultPulseName--,vm.numberOfRecord--,vm.pagination={start:0,end:0}),$("html,body").animate({scrollTop:$(".pulse-question-list-checkbox").offset().top-20},300)},vm.getAppropiateTemplate=function(options){if("MultipleChoice"!==options.type)return"/sp/resources/html/sysAdmin/pulse/template/linear.html";switch(angular.lowercase(options.displayKey)){case"group":return"/sp/resources/html/sysAdmin/pulse/template/multiple-group.html";case"grid":return"/sp/resources/html/sysAdmin/pulse/template/multiple-grid.html";default:return"/sp/resources/html/sysAdmin/pulse/template/multiple.html"}},vm.addLanguage=function(){vm.enableLanguage=!0,vm.csvFile=null},vm.resetUpload=function(){document.getElementById("mediaFormUpload").value="",vm.csvFile=null},vm.addPulseQuestions=function(param){ajaxService.getAjaxResponse({url:vm.serviceApis.addPulseQuestions,data:$.param(param)}).then(function(response){"true"===response.Success?(vm.enableLanguage=!1,vm.pulseDetail.locales.push(param.locale),languageOperation()):null!=response.error&&(sharedProperties.ajaxError(response.error),vm.enableLanguage=!1)})},vm.removePulseQuestionsDialog=function(param){vm.triggeredRequest=param,ngDialog.open({template:vm.modalUrl.removePulse,scope:vm})},vm.removePulseQuestions=function(param){ajaxService.getAjaxResponse({url:vm.serviceApis.removePulseQuestions,data:$.param(param)}).then(function(response){if("true"===response.Success){var index=vm.pulseDetail.locales.indexOf(param.locale);-1!==index&&vm.pulseDetail.locales.splice(index,1),vm.getDetails(ids),ngDialog.close()}else null!=response.error&&(ngDialog.close(),sharedProperties.ajaxError(response.error))})},vm.previewEditQuestion=function(){mapObject("edit"),vm.preview=!1,vm.questionEdit=!0},vm.submitUpdatedPulseRequest=function(form){if(vm.error.updatePulseSubmitted=!1,this.updatePulseQuestion.$valid){vm.getPreviewDetail.pulseId=vm.getPreviewDetail.id;var dataToSend=angular.copy(vm.getPreviewDetail);dataToSend.questionCategories=dataToSend.questionCategories.filter(function(e){return e.questions=e.questions.filter(function(e1){return void 0===e1.pageBreak}).map(function(e2,index){return e2.displayKey=null,-1!==vm.totalBreak[e.uid].indexOf(index)&&(e2.displayKey=index.toString()),e2})}),ajaxService.getAjaxResponse({url:vm.serviceApis.updatePulseQuestions,data:dataToSend,headers:{"Content-Type":"application/json"}}).then(function(response){"true"===response.Success?(vm.closePreview(),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.edit.success")),vm.getDetails(ids)):null!=response.error&&sharedProperties.ajaxError(response.error)})}else vm.error.updatePulseSubmitted=!0},vm.sortable=function(question){setView(),vm.oldIndex=0,null===practiceAreaSortVar&&(practiceAreaSortVar=new Sortable121(document.getElementById("sort-area"),{animation:150,ghostClass:"ghost",handle:".dHandle",yAxisOnly:!0,onStart:function(evt){var counts=0;$("#sort-area .question-set:gt("+(evt.oldIndex-1)+")").each(function(i,obj){$(obj).hasClass("pageBreak_true")&&counts++}),vm.oldIndex=evt.oldIndex-(vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].length-counts)},onEnd:function(evt){var newIndex=-1,indexToDelete=-1,qsLen=$(".question-set").length-1,count=0;if(evt.newIndex<1||qsLen===evt.newIndex)return indexToDelete=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].indexOf(vm.oldIndex),-1!==indexToDelete&&vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].splice(indexToDelete,1),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions[vm.oldIndex].displayKey=null,vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.splice(evt.oldIndex,1),$(".pageBreak_true:eq("+evt.newIndex+")").remove(),qsLen===evt.newIndex&&$(".question-set:eq("+evt.newIndex+")").remove(),setView(),!0;evt.oldIndex!==evt.newIndex&&(evt.oldIndex<qsLen?(indexToDelete=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].indexOf(vm.oldIndex),-1!==indexToDelete&&vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].splice(indexToDelete,1),count=0,$("#sort-area .question-set:gt("+(evt.newIndex-1)+")").each(function(i,obj){$(obj).hasClass("pageBreak_true")&&count++}),newIndex=evt.newIndex-1-(vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].length-count),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions[vm.oldIndex].displayKey=null,-1!==vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].indexOf(newIndex)?($(".question-set:eq("+evt.newIndex+")").remove(),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.splice(evt.oldIndex,1),setView()):(vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions[newIndex].displayKey=newIndex.toString(),vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].push(newIndex),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.move(evt.oldIndex,evt.newIndex))):(count=0,$("#sort-area .question-set:gt("+(evt.newIndex-1)+")").each(function(i,obj){$(obj).hasClass("pageBreak_true")&&count++}),newIndex=evt.newIndex-1-(vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].length-count),-1!==vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].indexOf(newIndex)?($(".question-set:eq("+evt.newIndex+")").remove(),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.splice(evt.oldIndex,1),setView()):(vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions[newIndex].displayKey=newIndex.toString(),vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].push(newIndex),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.move(vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.length-1,evt.newIndex))))}}))},vm.removePageBreak=function(evt){for(var i=0,evtIndex=-1;i<vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.length;i++)if(vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions[i].uid===evt.uid){evtIndex=i;break}var counts=0;$("#sort-area .question-set:gt("+(evtIndex-1)+")").each(function(i,obj){$(obj).hasClass("pageBreak_true")&&counts++});var oldIndex=evtIndex-(vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].length-counts),toDelete=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].indexOf(oldIndex);-1!==toDelete&&vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].splice(toDelete,1),vm.getPreviewDetail.questionCategories[vm.defaultPulseName].questions.splice(evtIndex,1),$(".question-set:eq("+evtIndex+")").remove(),setView("noScope")},vm.formatMonth=function(d){if(null!==d&&void 0!==d){var splitDate=d,formatMonth=$rootScope.pullInterNationalization("sysadmin.organization.month."+splitDate[1]);return splitDate[2]+" "+formatMonth+" "+splitDate[0]}},vm.init=function(){"edit"===mode&&vm.getDetails(ids),vm.attachEvent()},vm.init()}}}]);