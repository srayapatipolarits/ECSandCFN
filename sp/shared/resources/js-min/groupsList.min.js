angular.module("spApp").directive("groupsList",["ajaxService","sharedProperties","groupsService","$rootScope","spConfig","spValue","ngDialog","$filter","commonService","$localStorage",function(ajaxService,sharedProperties,groupsService,$rootScope,spConfig,spValue,ngDialog,$filter,commonService,$localStorage){var groupsListDirective={restrict:"EA",replace:!0,templateUrl:function(element,attrs){return"/sp/resources/html/people-analytics/"+attrs.urlSrc},link:function(scope,element,attrs){function init(){groupsService.getGroup().then(function(response){vm.groupList=response,vm.pageReady=!0,vm.groupList.length&&vm.getGroupDetail(vm.groupList[0].id)})}function updateSearchList(){allMail=angular.copy(vm.memberList);for(var i=0;i<vm.groupsDetail.users.length;i++)for(var j=vm.memberList.length-1;j>=0;j--)if(vm.groupsDetail.users[i].id===vm.memberList[j].id){delete allMail[j];break}vm.allMemberCall=!0,vm.searchListFn()}var vm=scope,allMail=[];vm.pageReady=!1,vm.groupList=[],vm.groupsDetail=null,vm.createGroupName="",vm.activeGroup=null,vm.showRenameGroup=!1,vm.showCreateGroup=!1,vm.memberList=[],vm.allMemberCall=!1,vm.pageSetting={errornewEmptyGroup:!1,errornewGroup:!1,savenewGroup:!1,newEmptyGroup:!1,newGroup:!1,searchForGroups:"",textSearching:"",memberListSearch:"",modeSelected:[]},vm.contentSetting={userSearching:"",pageSize:10,intialVal:10,lastReverse:!1,currentPredicate:"name",disabledInfinite:!1,user:[]},vm.negative=!1,vm.checkedAll=!1,vm.userInfo=$localStorage.get("loggegdInProfile"),vm.originalContentSetting=angular.copy(vm.contentSetting),vm.originalPageSetting=angular.copy(vm.pageSetting),vm.getGroupDetail=function(id){return vm.activeGroup===id||(vm.activeGroup=id,void groupsService.getGroupDetail({id:id}).then(function(response){return null===response||(vm.groupsDetail=response.hiringGroup,vm.order(vm.contentSetting.currentPredicate,vm.contentSetting.lastReverse),void(vm.allMemberCall=!1))}))},vm.saveNewGroup=function(groupName){return vm.pageSetting=angular.copy(vm.originalPageSetting),""===groupName||void 0===groupName?(vm.pageSetting.errornewEmptyGroup=!0,!1):void groupsService.userGroup({name:groupName},"createGroup").then(function(response){null===response&&(vm.pageSetting.errornewGroup=!0),vm.groupList.unshift(response.hiringGroup),vm.showCreateGroup=!1,vm.createGroupName="",vm.getGroupDetail(response.hiringGroup.id),sharedProperties.growlMessage($rootScope.pullInterNationalization("admin.group.saveMessage"))})},vm.renameGroup=function(renamedname){return vm.pageSetting=angular.copy(vm.originalPageSetting),""===renamedname?(vm.pageSetting.newEmptyGroup=!0,!0):renamedname===vm.groupsDetail.name||void groupsService.userGroup({id:vm.groupsDetail.id,name:renamedname},"renameGroup").then(function(response){null===response&&(vm.pageSetting.newGroup=!0),vm.groupsDetail.name=renamedname;for(var i=0;i<vm.groupList.length;i++)if(vm.groupsDetail.id===vm.groupList[i].id){vm.groupList[i].name=renamedname,spValue.getAllGroups=angular.copy(vm.groupList);break}sharedProperties.growlMessage($rootScope.pullInterNationalization("admin.group.profile.updateGroupNameMessage")),vm.renameGroupReset(!0)})},vm.deleteGroup=function(){groupsService.deleteGroup({id:vm.groupsDetail.id}).then(function(response){if(ngDialog.close("ngdialog1"),null===response)return!0;for(var i=0;i<vm.groupList.length;i++)if(vm.groupsDetail.id===vm.groupList[i].id){vm.groupList.splice(i,1),vm.groupsDetail=null,spValue.getAllGroups=angular.copy(vm.groupList),init();break}sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.groupDeletedSuccefully"))})},vm.addUsers=function(){groupsService.userGroup({id:vm.groupsDetail.id,userIds:vm.addedList},"addUser").then(function(response){if(ngDialog.close("ngdialog1"),null===response)return!0;vm.pageSetting=angular.copy(vm.originalPageSetting);for(var i=0;i<response.hiringGroupUsers.length;i++)vm.groupsDetail.users.push(response.hiringGroupUsers[i]);for(var j=0;j<vm.groupList.length;j++)if(vm.groupsDetail.id===vm.groupList[j].id){vm.groupList[j].count=vm.groupsDetail.users.length;break}vm.order(vm.contentSetting.currentPredicate,vm.contentSetting.lastReverse),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.memberAddedtogroup"))})},vm.deleteUsers=function(userIds,single){var userList=[];if(single)userList.push(userIds);else for(var e=0;e<userIds.length;e++)userList.push(userIds[e].userId);groupsService.userGroup({id:vm.groupsDetail.id,userIds:userList},"removeUser").then(function(response){if(ngDialog.close("ngdialog1"),null===response)return!0;vm.contentSetting=angular.copy(vm.originalContentSetting),vm.negative=!1,vm.contentSetting.user=[];for(var i=vm.groupsDetail.users.length-1;i>=0;i--)userList.indexOf(vm.groupsDetail.users[i].id)!==-1&&vm.groupsDetail.users.splice(i,1);for(var j=0;j<vm.groupList.length;j++)if(vm.groupsDetail.id===vm.groupList[j].id){vm.groupList[j].count=vm.groupsDetail.users.length;break}sharedProperties.growlMessage($rootScope.pullInterNationalization("admin.group.profile.deleteMessage"))})},vm.confirmDeleteUser=function(userIds,single){console.log("deleteUser")},vm.resetCreateNewGroup=function(cancel){vm.showCreateGroup=!cancel,vm.pageSetting.errornewEmptyGroup=!1,vm.pageSetting.errornewGroup=!1,vm.createGroupName=""},vm.renameGroupReset=function(rename){vm.showRenameGroup=!rename,vm.newEmptyGroup=!1,vm.newGroup=!1,vm.newGroupSelector=vm.groupsDetail.name},vm.includeCheck=function(status,area){var i=$.inArray(status,area);i>-1?area.splice(i,1):area.push(status),vm.searchListFn()},vm.searchListFn=function(searchClear){searchClear&&(vm.pageSetting.memberListSearch=""),vm.searchList=allMail.filter(function(e){return void 0===e.name&&(e.name=e.firstName+" "+e.lastName),(vm.pageSetting.modeSelected.length?vm.pageSetting.modeSelected.indexOf(e.type)!==-1:e)&&sharedProperties.singleElementSearch(vm.pageSetting.memberListSearch,e,2)})},vm.makeMemberList=function(id){var added=$.inArray(id,vm.addedList);added>-1?vm.addedList.splice(added,1):vm.addedList.push(id)},vm.active=function(event,setting){vm.contentSetting.currentPredicate=setting.predicate,vm.contentSetting.lastReverse=setting.reverse,sharedProperties.toggleFilterClick(event,vm.contentSetting.currentPredicate),vm.order(vm.contentSetting.currentPredicate,vm.contentSetting.lastReverse)},vm.order=function(predicate,reverse){vm.contentSetting.currentPredicate=predicate,vm.contentSetting.lastReverse=reverse,vm.groupsDetail.users=$filter("orderBy")(vm.groupsDetail.users,vm.contentSetting.currentPredicate,vm.contentSetting.lastReverse)},vm.pageCounter=function(pageSize,nosorting){"undefined"==typeof nosorting&&vm.order(vm.contentSetting.currentPredicate,vm.contentSetting.lastReverse),vm.contentSetting.pageSize=pageSize,pageSize>=vm.groupsDetail.users.length&&(vm.contentSetting.disabledInfinite=!0,vm.contentSetting.pageSize=pageSize)},vm.checkAll=function(checked){checked?vm.contentSetting.user=vm.groupsDetail.users.map(function(item){return{userId:item.id,email:item.email,name:item.name,title:item.title}}):vm.contentSetting.user=[]},vm.checkCount=function(checked){var userLength=vm.contentSetting.user.length;checked&&userLength+1===vm.groupsDetail.users.length?vm.negative=!0:vm.negative=!1},vm.sendEmailReminders=function(status,email){commonService.sendEmail(status,email)},vm.viewMemberDetails=function(email,f){scope.$parent.updateView("memberDetails",!1,email)},vm.deletePopup=function(){ngDialog.open({template:spConfig.talentAnalytics.groupService.dialog.deleteGroup,scope:vm})},vm.removeMultiMember=function(){ngDialog.open({template:spConfig.talentAnalytics.groupService.dialog.removeMulti,scope:vm})},vm.removeSingleMember=function(memberObj){vm.deleteMemberInfo=memberObj,ngDialog.open({template:spConfig.talentAnalytics.groupService.dialog.removeSingle,scope:vm})},vm.deleteSingleModal=function(member){vm.deleteMemberInfo=member,ngDialog.open({template:spConfig.talentAnalytics.groupService.dialog.deleteSingle,scope:vm})},vm.addMembersModal=function(){vm.addedList=[],groupsService.getAllMembers({validOnly:!0}).then(function(response){return null===response||(vm.pageSetting=angular.copy(vm.originalPageSetting),vm.memberList=response.hiring,vm.memberListSearch="",updateSearchList(),void ngDialog.open({template:spConfig.talentAnalytics.groupService.dialog.addMemberModalGroup,scope:vm}))})},init()}};return groupsListDirective}]);