angular.module("spApp").directive("idealPortrait",["spConfig","sharedProperties","spValue","$q","$rootScope","$state","idealPortraitAdminService","memberService","ngDialog",function(spConfig,sharedProperties,spValue,$q,$rootScope,$state,idealPortraitAdminService,memberService,ngDialog){return{restrict:"EA",replace:!0,templateUrl:function(element,attrs){return attrs.urlSrc||"/sp/resources/html/sysAdmin/peopleAnalytics/Ideal-Portrait/view/portrait.html"},link:function(scope,element,attrs){function savePortrait(){"create"===vm.pageType||"clone"===vm.pageType?idealPortraitAdminService.create(vm.portraitMatch).then(function(response){if(null===response)return!0;ngDialog.close("ngdialog1"),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.idealPortraitCreated")),window.location.href="/sp/sysAdmin/idealPortrait/update?pid="+response.portraitMatch.id}):idealPortraitAdminService.update(vm.portraitMatch).then(function(response){if(null===response)return!0;ngDialog.close("ngdialog1"),vm.portraitMatch=angular.copy(response.portraitMatch),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.idealPortraitUpdated"))})}function createdUserSelectedVariable(){for(var key in vm.portraitMatch.categoryDataMap)for(var el in vm.portraitMatch.categoryDataMap[key])if(vm.portraitMatch.categoryDataMap[key][el].enabled&&(vm.filterSelected[key].push(el),vm.totalSelected++),"Personality"===key&&-1!==vm.filterSelected[key].indexOf(el))for(var i=0,e=vm.portraitMatch.categoryDataMap[key][el];i<e.matchCriterias.length;i++)vm.addedTraits[el].push(e.matchCriterias[i].key),vm.matchDropDown[el][vm.indexDrop.indexOf(e.matchCriterias[i].matchPercent)].checked=!0,vm.matchDropDown[el+"Selected"].push(e.matchCriterias[i].key);else if("Personality"===key&&-1===vm.filterSelected[key].indexOf(el))for(var ii=0,ee=vm.portraitMatch.categoryDataMap[key][el];ii<ee.matchCriterias.length;ii++)vm.addedTraits[el].push(ee.matchCriterias[ii].key),vm.matchDropDown[el][vm.indexDrop.indexOf(ee.matchCriterias[ii].matchPercent)].checked=!0,vm.matchDropDown[el+"Selected"].push(ee.matchCriterias[ii].key);else"ConflictManagement"!==key&&"FundamentalNeeds"!==key||vm.portraitMatch.categoryDataMap[key][el].matchCriterias.length&&(vm.active[key]="Secondary",vm[key].addedList.push(vm.portraitMatch.categoryDataMap[key][el].matchCriterias[0].key))}function getPortraitDetail(pageType){var pid=sharedProperties.getParam("pid");null===pid&&(window.location.href="/sp/sysAdmin/idealPortrait"),idealPortraitAdminService.get({id:pid}).then(function(response){if(null===response)return!0;vm.portraitMatch=angular.copy(response.portraitMatch),vm.lastcategoryPriorityWeightMap={Essential:100*vm.portraitMatch.categoryPriorityWeightMap.Essential,Secondary:100*vm.portraitMatch.categoryPriorityWeightMap.Secondary},createdUserSelectedVariable(),"clone"===pageType&&(vm.portraitMatch.id=null,vm.portraitMatch.name=$rootScope.pullInterNationalization("sysadmin.organization.copyof")+" "+vm.portraitMatch.name,vm.portraitMatch.categoryPriorityWeightMap=portraitMatch.categoryPriorityWeightMap),vm.portraitTags=[],!angular.isArray(vm.portraitMatch.tags)&&(vm.portraitMatch.tags=[]);for(var i=0;i<vm.portraitMatch.tags.length;i++)vm.portraitTags.push({text:vm.portraitMatch.tags[i]})})}var vm=scope;vm.pageReady=!1,vm.pageType=attrs.type,vm.protraitTabs=["Personality","Processing","DecisionMaking","ConflictManagement","Motivation","FundamentalNeeds","LearningStyle"],vm.activeTabs=null,vm.previousTabs=null,vm.error={portraitSubmitted:!1,portraitSelected:!1},vm.portraitTags=[],vm.maximumTrait=5,vm.lastcategoryPriorityWeightMap={},vm.addedTraits={Primary:[],UnderPressure:[]},vm.matchDropDown={Primary:[{name:100,checked:!1},{name:90,checked:!1},{name:80,checked:!1}],UnderPressure:[{name:100,checked:!1},{name:90,checked:!1},{name:80,checked:!1}],PrimarySelected:[],UnderPressureSelected:[]},vm.indexDrop=[100,90,80],vm.personalityTraits=["Supporter","Actuary","Ambassador","Visionary","Motivator","Examiner","Instructor","Promoter","Encourager","Innovator","Researcher","Pragmatist","Refiner","Navigator","Designer","Tough_N_Tender"],vm.traitDescription=["Powerfull","Adaptable","Versatile","Precise"],vm.active={ConflictManagement:"Primary",FundamentalNeeds:"Primary"},vm.ConflictManagement={list:[{name:"Collaborate",Primary:!0,Secondary:!0},{name:"Compete",Primary:!0,Secondary:!0},{name:"Accommodate",Primary:!0,Secondary:!0},{name:"Compromise",Primary:!1,Secondary:!0},{name:"Avoid",Primary:!1,Secondary:!0}],addedList:[]},vm.FundamentalNeeds={list:[{name:"Control",Primary:!0,Secondary:!0},{name:"Significance",Primary:!0,Secondary:!0},{name:"Security",Primary:!1,Secondary:!0}],addedList:[]},vm.filterSelected={ConflictManagement:[],FundamentalNeeds:[],Motivation:[],Processing:[],LearningStyle:[],Personality:[],DecisionMaking:[]},vm.totalSelected=0,vm.totalTraits=21;var portraitMatch={id:null,name:null,description:null,tags:[],categoryDataMap:{ConflictManagement:{Primary:{enabled:!1,matchCriterias:[]},Secondary:{enabled:!1,matchCriterias:[]}},FundamentalNeeds:{Primary:{enabled:!1,matchCriterias:[]},Secondary:{enabled:!1,matchCriterias:[]}},Motivation:{AttainmentOfGoals:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Power:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Activity:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},SelfAffirmed:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},ExchangeOfIdeas:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Freedom:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},TaskCompletion:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Hygiene:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]}},Processing:{External:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Concrete:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Cognitive:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Orderly:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]}},LearningStyle:{Global:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]}},Personality:{Primary:{enabled:!0,matchCriterias:[]},UnderPressure:{enabled:!1,matchCriterias:[]}},DecisionMaking:{Outward:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]},Careful:{enabled:!1,matchCriterias:[{key:null,matchPercent:50}]}}},categoryPriorityWeightMap:{Essential:.5,Secondary:.5}};vm.createUpdatePortraitMatch=function(formData){vm.error.portraitSubmitted=!1,formData.$valid&&-1!==vm.filterSelected.Personality.indexOf("Primary")?1===vm.totalSelected&&vm.filterSelected.Personality.length?(vm.lastcategoryPriorityWeightMap={Essential:100,Secondary:0},vm.saveWeight()):(vm.lastcategoryPriorityWeightMap={Essential:100*vm.portraitMatch.categoryPriorityWeightMap.Essential,Secondary:100*vm.portraitMatch.categoryPriorityWeightMap.Secondary},ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.setWeight,scope:vm})):vm.error.portraitSubmitted=!0},vm.saveWeight=function(){vm.portraitMatch.categoryPriorityWeightMap.Secondary=angular.copy((100-vm.lastcategoryPriorityWeightMap.Essential)/100),vm.portraitMatch.categoryPriorityWeightMap.Essential=angular.copy(vm.lastcategoryPriorityWeightMap.Essential/100),vm.lastcategoryPriorityWeightMap.Secondary=angular.copy(100-vm.lastcategoryPriorityWeightMap.Essential),savePortrait()},vm.updateTab=function(index,viewName){if(vm.activeTabs===index)return!0;vm.activeTabs=viewName,sharedProperties.fireAnalyticsEvent("People Analytics | Ideal Portrait",vm.activeTabs+"PA"),$state.transitionTo(vm.activeTabs+"PA")},vm.includeCheck=function(status,area,select){var i=$.inArray(status,area);i>-1?(area.splice(i,1),void 0===select&&vm.totalSelected--):(area.push(status),void 0===select&&vm.totalSelected++)},vm.includeCheckConditional=function(primary,secondary,area){!primary.enabled&&secondary.enabled?(secondary.enabled=!1,vm.includeCheck("Secondary",vm.filterSelected[vm.activeTabs]),vm.includeCheck("Primary",vm.filterSelected[vm.activeTabs])):primary.enabled&&!secondary.enabled?(secondary.matchCriterias.length&&(secondary.enabled=!0),secondary.matchCriterias.length&&vm.includeCheck("Secondary",vm.filterSelected[vm.activeTabs]),vm.includeCheck("Primary",vm.filterSelected[vm.activeTabs])):primary.enabled||secondary.enabled||vm.includeCheck("Primary",vm.filterSelected[vm.activeTabs])},vm.addTraits=function(obj,value,keys){if(obj.matchCriterias.length<vm.maximumTrait){for(var i=0,index=2;i<vm.matchDropDown[keys].length;i++)if(!1===vm.matchDropDown[keys][i].checked&&-1===vm.matchDropDown[keys+"Selected"].indexOf(vm.matchDropDown[keys][i].name)){index=i;break}obj.matchCriterias.push({key:value,matchPercent:vm.matchDropDown[keys][index].name}),1===obj.matchCriterias.length&&(obj.enabled=!0,vm.includeCheck(keys,vm.filterSelected.Personality)),vm.addedTraits[keys].push(value),vm.matchDropDown[keys][index].checked=!0,vm.matchDropDown[keys+"Selected"].push(vm.matchDropDown[keys][index].name)}},vm.removeTraits=function(obj,value,keys){for(var i=0;i<obj.matchCriterias.length;i++)if(obj.matchCriterias[i].key===value){for(var j=0;j<vm.matchDropDown[keys].length;j++)if(vm.matchDropDown[keys][j].name===obj.matchCriterias[i].matchPercent){if(vm.matchDropDown[keys][j].checked=!1,vm.addedTraits[keys].splice(i,1),vm.matchDropDown[keys+"Selected"].splice(i,1),0===i&&obj.matchCriterias.length>1){var lastIndex=vm.indexDrop.indexOf(obj.matchCriterias[1].matchPercent);obj.matchCriterias[1].matchPercent=vm.matchDropDown[keys][0].name,vm.matchDropDown[keys][lastIndex].checked=!1,vm.matchDropDown[keys][0].checked=!0,vm.matchDropDown[keys+"Selected"][0]=100}break}obj.matchCriterias.splice(i,1),!obj.matchCriterias.length&&obj.enabled&&(obj.enabled=!1,vm.includeCheck(keys,vm.filterSelected.Personality));break}},vm.changeDisabledState=function(newValue,oldValue,keys,index){vm.matchDropDown[keys][vm.indexDrop.indexOf(oldValue.matchPercent)].checked=!1,vm.matchDropDown[keys][vm.indexDrop.indexOf(newValue)].checked=!0,vm.matchDropDown[keys+"Selected"][index]=newValue,oldValue.matchPercent=newValue},vm.addConflict=function(obj,trait,keys,list){obj[keys].matchCriterias.push({key:trait.name,matchPercent:null}),obj[keys].enabled=!0,vm.includeCheck(keys,vm.filterSelected[vm.activeTabs],!1),vm.includeCheck(trait.name,list.addedList),vm.active[vm.activeTabs]="Secondary"},vm.removeConflict=function(obj,trait,keys){"Primary"===keys?(obj[keys].enabled=!1,obj.Secondary.enabled=!1,obj[keys].matchCriterias.length&&vm.filterSelected[vm.activeTabs].length&&vm.includeCheck(keys,vm.filterSelected[vm.activeTabs]),obj.Secondary.matchCriterias.length&&vm.filterSelected[vm.activeTabs].length&&vm.includeCheck("Secondary",vm.filterSelected[vm.activeTabs]),obj[keys].matchCriterias.splice(0,1),obj.Secondary.matchCriterias.splice(0,1),trait.addedList=[],vm.active[vm.activeTabs]="Primary"):(obj[keys].matchCriterias.length&&(vm.includeCheck(keys,vm.filterSelected[vm.activeTabs],!1),vm.includeCheck(obj[keys].matchCriterias[0].key,trait.addedList)),obj[keys].enabled=!1,obj[keys].matchCriterias.splice(0,1),vm.active[vm.activeTabs]="Secondary")},vm.previewDetail=function(){if(!vm.totalSelected)return!0;ngDialog.open({template:spConfig.admin.talentAnalytics.idealPortrait.dialog.preview,scope:vm})},vm.loadSource=function(query,format){var deferred=$q.defer(),result=[];return deferred.resolve(result),deferred.promise},vm.tagAdded=function(tag){void 0!==tag.text&&vm.portraitMatch.tags.push(tag.text)},vm.tagRemoved=function(tag){vm.portraitMatch.tags.splice(vm.portraitMatch.tags.indexOf(tag.text),1)},vm.init=function(){if(""===window.location.hash)vm.activeTabs="Personality";else{var viewName=window.location.href.split("#/")[1];-1!==viewName.indexOf("?")&&(viewName=viewName.split("?")[0]),vm.activeTabs=viewName.slice(0,-2)}$state.go(vm.activeTabs+"PA"),vm.portraitMatch="create"===vm.pageType?angular.copy(portraitMatch):getPortraitDetail(vm.pageType)};var stateNotFound=vm.$on("$stateNotFound",function(event){stateNotFound(),event.preventDefault(),vm.activeTabs="Personality",$state.transitionTo(vm.activeTabs+"PA")});vm.init()}}}]),angular.module("spApp").directive("rangeDrag",["$rootScope",function($rootScope){return{restrict:"E",replace:!1,templateUrl:"/sp/resources/html/sysAdmin/peopleAnalytics/Ideal-Portrait/view/twoRangeDrag.html",scope:{data_1:"=rangeData1",dragRange:"=dragRange",editable:"=editable",updateFn:"&updateFn",checkboxFn:"&checkboxFn",steps:"=steps",label1:"=label1",label2:"=label2"},link:function(scope,element,attr){var inputCreator=function(){var ele=$(element).find(".dragdealer")[0],leftRange=$(element).find(".labels .minRange .number"),rightRange=$(element).find(".labels .maxRange .number"),dragRange=angular.copy((100-scope.dragRange)/100);new Dragdealer(ele,{steps:scope.steps,snap:!0,animationCallback:function(x,y){var xAxis=Math.round(100-100*x),yAxis=Math.round(100*x);leftRange.text(xAxis+"%"),rightRange.text(yAxis+"%")},dragStartCallback:function(x,y){scope.editable||scope.$apply(function(){(scope.editable=!0)&&scope.checkboxFn()})},callback:function(x,y){sliderValue(x),scope.editable||scope.$apply(function(){(scope.editable=!0)&&scope.checkboxFn()})},x:dragRange})},sliderValue=function(x){var xAxis=Math.round(100-100*x);Math.round(100*x);scope.$apply(function(){xAxis!==scope.data_1&&(scope.data_1=xAxis)})};void 0!==scope.editable&&inputCreator()}}}]);