angular.module("spApp").directive("pulseList",["ngDialog","sharedProperties","$rootScope","ajaxService","$filter",function(ngDialog,sharedProperties,$rootScope,ajaxService,$filter){return{restrict:"E",templateUrl:function(element,attrs){return"/sp/resources/html/sysAdmin/pulse/"+attrs.urlSrc},link:function(scope,element,attrs){function order(predicate,reverse){vm.pageSetting.lastPredicate=predicate,vm.pageSetting.lastReverse=reverse,vm.pulseList=$filter("orderBy")(vm.pulseList,vm.pageSetting.lastPredicate,vm.pageSetting.lastReverse)}function mapObject(edit){var sorted=angular.copy(vm.getPreviewDetail.questionCategories);if(vm.getPreviewDetail.questionCategories.filter(function(e,index){var breaking=[];vm.totalBreak[e.uid]=[];for(var i=0;i<e.questions.length;i++)if(sorted[index].questions[i+breaking.length].index=i+1,e.questions[i].displayKey){var idx=parseInt(e.questions[i].displayKey,10)+breaking.length;vm.totalBreak[e.uid].push(parseInt(e.questions[i].displayKey)),void 0!==edit&&(sorted[index].questions.splice(idx,0,{pageBreak:!0,uid:"pageBreak"+Math.random(),idx:idx,key:i}),breaking.push(breaking.length))}}),void 0===edit){vm.totoalNumberOfRecord=0;for(var key in vm.totalBreak){var length=vm.totalBreak[key].length+1;vm.totoalNumberOfRecord=vm.totoalNumberOfRecord+length}}vm.getPreviewDetail.questionCategories=angular.copy(sorted)}var vm=scope;vm.serviceApis={getAll:"/sp/sysAdmin/pulse/getAll",updateStatus:"/sp/sysAdmin/pulse/updateStatus",getPreview:"/sp/sysAdmin/pulse/getPreview",deletePulseQuestionSet:"/sp/sysAdmin/pulse/deleteQuestionSet"},vm.modalUrl={removePulseQuestionSet:"/sp/resources/html/sysAdmin/pulse/dialog/remove-questionset.html"},vm.pulseMasterList=[],vm.pulseList=[],vm.responseRecieved=!1,vm.pageSetting={pageSize:10,lastPredicate:"name",lastReverse:!1,disabledInfinite:!1,textSearching:""},vm.originalpageSetting=angular.copy(vm.pageSetting),vm.getPreviewDetail=null,vm.preview=!1,vm.mapObject=[],vm.totalBreak={},vm.companyInList=[],vm.pagination={start:0,end:0},vm.triggeredRequest=null,vm.numberOfRecord=0,vm.totoalNumberOfRecord=0,vm.getAll=function(){ajaxService.getAjaxResponse({url:vm.serviceApis.getAll}).then(function(response){"true"===response.Success?(vm.pulseMasterList=response.pulseListing,vm.companyInList=response.companyList,vm.responseRecieved=!0,vm.returnMemberList(vm.pageSetting.pageSize)):null!=response.error&&sharedProperties.ajaxError(response.error)})},vm.returnMemberList=function(pageSize){if(!vm.pulseMasterList.length)return!0;vm.pageSetting.pageSize=vm.originalpageSetting.pageSize,vm.pageSetting.disabledInfinite=!1,vm.pulseList=vm.pulseMasterList.filter(function(e){return-1!==angular.lowercase(e.name).indexOf(angular.lowercase(vm.pageSetting.textSearching))}),order(vm.pageSetting.lastPredicate,vm.pageSetting.lastReverse)},vm.active=function(event,setting){vm.pageSetting.lastPredicate=setting.predicate,vm.pageSetting.lastReverse=setting.reverse,sharedProperties.toggleFilterClick(event,vm.pageSetting.lastPredicate),order(vm.pageSetting.lastPredicate,vm.pageSetting.lastReverse)},vm.formatMonth=function(d){if(null!==d&&void 0!==d){var splitDate=d,formatMonth=$rootScope.pullInterNationalization("sysadmin.organization.month."+splitDate[1]);return splitDate[2]+" "+formatMonth+" "+splitDate[0]}},vm.pulseDetail=function(id){window.location.href="/sp/sysAdmin/pulse/edit?viewable="+id},vm.updateStatus=function(param){ajaxService.getAjaxResponse({url:vm.serviceApis.updateStatus,data:$.param({pulseQuestionSetId:param.id,status:param.status})}).then(function(response){if("true"===response.Success){for(var i=0;i<vm.pulseMasterList.length;i++)if(vm.pulseMasterList[i].id===param.id){vm.pulseMasterList[i].status=param.status,sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.status.update"));break}vm.returnMemberList(vm.pageSetting.pageSize)}else null!=response.error&&sharedProperties.ajaxError(response.error)})},vm.getPreview=function(param){ajaxService.getAjaxResponse({url:vm.serviceApis.getPreview,data:$.param(param)}).then(function(response){"true"===response.Success?(vm.getPreviewDetail=response.pulseQuestion,vm.defaultPulseName=0,vm.pagination={start:0,end:0},vm.numberOfRecord=0,mapObject(),vm.preview=!0):null!=response.error&&sharedProperties.ajaxError(response.error)})},vm.previous=function(){0!==vm.pagination.end&&(vm.pagination.end--,vm.pagination.start=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid][vm.pagination.end-1])},vm.next=function(){vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].length-1>vm.pagination.end&&++vm.pagination.end&&(vm.pagination.start=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid][vm.pagination.end-1])},vm.closePreview=function(){vm.getPreviewDetail=null,vm.defaultPulseName=0,vm.preview=!1},vm.increment=function(validate){vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid].length>vm.pagination.end?(vm.pagination.end++,vm.numberOfRecord++,vm.pagination.end&&(vm.pagination.start=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid][vm.pagination.end-1])):vm.defaultPulseName<vm.getPreviewDetail.questionCategories.length-1&&(vm.defaultPulseName++,vm.numberOfRecord++,vm.pagination={start:0,end:0}),$("html,body").animate({scrollTop:$(".pulse-question-list-checkbox").offset().top-20},300)},vm.decrement=function(validate){0!==vm.pagination.end?(vm.pagination.end--,vm.numberOfRecord--,vm.pagination.start=vm.totalBreak[vm.getPreviewDetail.questionCategories[vm.defaultPulseName].uid][vm.pagination.end-1]):vm.defaultPulseName>0&&(vm.defaultPulseName--,vm.numberOfRecord--,vm.pagination={start:0,end:0}),$("html,body").animate({scrollTop:$(".pulse-question-list-checkbox").offset().top-20},300)},vm.getAppropiateTemplate=function(options){if("MultipleChoice"!==options.type)return"/sp/resources/html/sysAdmin/pulse/template/linear.html";switch(angular.lowercase(options.displayKey)){case"group":return"/sp/resources/html/sysAdmin/pulse/template/multiple-group.html";case"grid":return"/sp/resources/html/sysAdmin/pulse/template/multiple-grid.html";default:return"/sp/resources/html/sysAdmin/pulse/template/multiple.html"}},vm.getCompanyName=function(id){for(var i=0;i<vm.companyInList.length;i++)if(vm.companyInList[i].id===id)return vm.companyInList[i].name},vm.deletePulseQuestionSetDialog=function(param){vm.triggeredRequest=param,ngDialog.open({template:vm.modalUrl.removePulseQuestionSet,scope:vm})},vm.deletePulseQuestionSet=function(param){ajaxService.getAjaxResponse({url:vm.serviceApis.deletePulseQuestionSet,data:$.param(param)}).then(function(response){if("true"===response.Success){ngDialog.close();for(var i=0;i<vm.pulseMasterList.length;i++)if(vm.pulseMasterList[i].id===param.pulseQuestionSetId){vm.pulseMasterList.splice(i,1);break}vm.returnMemberList(vm.pageSetting.pageSize),sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.deleted.success"))}else null!=response.error&&(ngDialog.close(),sharedProperties.ajaxError(response.error))})},vm.init=function(){vm.getAll()},vm.init()}}}]);