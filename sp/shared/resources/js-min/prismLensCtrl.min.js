function prismLensController($scope,ajaxService,$filter,ngDialog,sharedProperties,$rootScope,$timeout,$q,$localStorage){function shrinkDt(dt){var dtSplit;if(void 0!==dt&&null!==dt&&""!==dt)return dtSplit=dt.split(" "),dtSplit[0].substring(0,3)+" "+dtSplit[1]+" "+dtSplit[2]}function sendReminder(email,id){ajaxService.getAjaxResponse({url:_this.services.sendReminder,data:$.param({brandHeader:"",ctaLabel:"",ctaUrl:"",logType:"PrismLens",type:"FeedbackReminder",memberList:email,feedbackUserId:id})}).then(function(response){"true"===response.Success?sharedProperties.growlMessage($rootScope.pullInterNationalization("prismLens.sendReminder")):null!==response.error&&(ngDialog.close(),sharedProperties.ajaxError(response.error))})}function deleteConfirm(info){_this.deleteInfo=info,ngDialog.open({template:"/sp/resources/html/feedback/delete-feedback-pop.html",scope:$scope})}function deleteFeedback(id){ajaxService.getAjaxResponse({url:_this.services.deleteRequest,data:$.param({feedbackUserId:id})}).then(function(response){if("true"===response.Success){for(var list=angular.copy(_this.feedbackTeamList),i=list.length-1;i>=0;i--)if(list[i].id===id){list.splice(i,1);break}_this.feedbackTeamList=angular.copy(list),getAllFeedbackMembers(),ngDialog.close(),sharedProperties.growlMessage($rootScope.pullInterNationalization("prismLens.feedbackDeleted"))}else null!==response.error&&(ngDialog.close(),sharedProperties.ajaxError(response.error))})}function getAllFeedbackMembers(){ajaxService.getAjaxResponse({url:_this.services.getAllFeedbackMembers,data:$.param({groupMemberEmail:""})}).then(function(response){"true"===response.Success?(_this.getAllMembersToInvite=response,null!==$localStorage.get("feedbackUserId")&&_this.getFeedbackDetails($localStorage.get("feedbackUserId"),!0),$timeout(function(){$rootScope.setContentReferenceForModule({mainModule:"Prism Lens",subModule:""},"prismLens")},1e3),$rootScope.showStickyTutorial=!0):null!==response.error&&sharedProperties.ajaxError(response.error)})}function getFeedbackDetails(memberObj,focus){if(_this.feedbackEnable=!1,_this.featuresSectionSelected!==memberObj.id?_this.featuresSectionSelected=memberObj.id:_this.featuresSectionSelected=-1,"VALID"===memberObj.userStatus){var storedProfile=$localStorage.get(memberObj.id);void 0!==storedProfile&&null!==storedProfile?(_this.getInviteMemberDetail=storedProfile,_this.swotMemId=memberObj.id,_this.swotanalysis=storedProfile.swotanalysis,void 0!==storedProfile.swotanalysis&&(_this.feedbackEnable=!0)):ajaxService.getAjaxResponse({url:_this.services.getFeedbackDetails,data:$.param({feadbackUserId:memberObj.id,groupMemberEmail:""})}).then(function(response){"true"===response.Success?($localStorage.set(memberObj.id,response),_this.getInviteMemberDetail=response,_this.swotMemId=memberObj.id,_this.swotanalysis=response.swotanalysis,void 0!==response.swotanalysis&&(_this.feedbackEnable=!0),void 0!==focus&&$("html,body").animate({scrollTop:$("#"+memberObj.id).offset().top},1e3)):null!==response.error&&sharedProperties.ajaxError(response.error)})}}function getFeedbackTeam(){getAllFeedbackMembers(),ajaxService.getAjaxResponse({url:_this.services.getFeedbackTeam+"?accountDashboardRequest=true&groupMemberEmail=",method:"get"}).then(function(response){"true"===response.Success?(_this.feedbackDataResponse=!0,_this.feedbackTeamList=response.feedbackTeam,moment.locale(sharedProperties.provideVendorSpecificLocale("datePicker")),$('input[name="endDate"]').daterangepicker({showDropdowns:!1,minDate:moment(),locale:{format:"MM/DD/YYYY"},alwaysShowCalendars:!0,singleDatePicker:!0,autoUpdateInput:!1,opens:"right"},function(start,end,label){$scope.$apply(function(){_this.untilDate=start.format("MM/DD/YYYY")})}),_this.isId&&(_this.getFeedbackDetails({id:_this.isId,userStatus:"VALID"},!0),$timeout(function(){_this.isId=null},100))):null!==response.error&&sharedProperties.ajaxError(response.error)})}function resetErrors(){_this.formErrors={dateCheck:!1,emailCheck:!1,firstName:!1,lastName:!1}}function showHideRequestFeedbackForm(){_this.showRequestFeedbackForm=!_this.showRequestFeedbackForm,resetErrors()}function loadTags(query){_this.showNames=!1,_this.formErrors.emailCheck=!1;var deferred=$q.defer(),result=_this.getAllMembersToInvite.feedbackUsers.filter(function(e){return-1!==e.name.toLowerCase().indexOf(query.toLowerCase())||-1!==e.email.toLowerCase().indexOf(query.toLowerCase())});return deferred.resolve(result),deferred.promise}function tagAdded(tag){_this.showNames=!1,_this.searchTag.push(tag.email),_this.selectedUser=tag,void 0!==tag.id&&null!==tag.id&&""!==tag.id||(_this.showNames=!0)}function tagRemoved(tag){_this.formErrors.emailCheck=!1,_this.showNames=!1,_this.nameDataFormfirstName="",_this.nameDataFormlastName="",_this.selectedUser=null,_this.searchTag.splice(_this.searchTag.indexOf(tag.email),1)}function sendRequestFeedbackAdmin(date,fName,lName){if(resetErrors(),void 0!==date&&null!==date&&""!==date||(_this.formErrors.dateCheck=!0),void 0===_this.selectedUser||null===_this.selectedUser||""===_this.selectedUser?_this.formErrors.emailCheck=!0:(void 0!==_this.selectedUser.email&&null!==_this.selectedUser.email&&""!==_this.selectedUser.email||(_this.formErrors.emailCheck=!0),void 0!==_this.selectedUser.id&&null!==_this.selectedUser.id&&""!==_this.selectedUser.id||(void 0===fName||null===fName||""===fName?_this.formErrors.firstName=!0:(_this.formErrors.firstName=!1,_this.selectedUser.firstName=fName),void 0===lName||null===lName||""===lName?_this.formErrors.lastName=!0:(_this.formErrors.lastName=!1,_this.selectedUser.lastName=lName))),!1===_this.formErrors.dateCheck&&!1===_this.formErrors.emailCheck&&!1===_this.formErrors.firstName&&!1===_this.formErrors.lastName){var param={firstName:_this.selectedUser.firstName,lastName:_this.selectedUser.lastName,email:_this.selectedUser.email,requestType:void 0===_this.selectedUser.id||null===_this.selectedUser.id||""===_this.selectedUser.id?"EXTERNAL":"INTERNAL",referenceType:"Colleague",comment:"",endDate:date,groupMemberEmail:""};ajaxService.getAjaxResponse({url:_this.services.submitFeedbackRequest,data:$.param(param)}).then(function(response){"true"===response.Success?(getFeedbackTeam(),showHideRequestFeedbackForm(),_this.searchTag=[],_this.nameDataFormfirstName="",_this.nameDataFormlastName="",_this.untilDate=null,_this.showNames=!1,_this.nameDataFormfirstName="",_this.nameDataFormlastName="",$timeout(function(){angular.element($(".remove-button")).triggerHandler("click")},100),sharedProperties.growlMessage($rootScope.pullInterNationalization("prismLens.memberInvited")),sharedProperties.fireAnalyticsEvent("Prism Lens | Request Prism Lens","N/A")):null!==response.error&&sharedProperties.ajaxError(response.error)})}}var _this=this;_this.services={getAllFeedbackMembers:"/sp/feedback/getAllFeedbackMembers",getFeedbackTeam:"/sp/feedback/getFeedbackTeam",getFeedbackDetails:"/sp/feedback/getFeedbackDetails",submitFeedbackRequest:"/sp/feedback/submitFeedbackRequest",deleteRequest:"/sp/feedback/delete",sendReminder:"/sp/notifications/sendNotificationWithParams"},_this.getAllFeedbackMembers=getAllFeedbackMembers,_this.getFeedbackTeam=getFeedbackTeam,_this.getFeedbackDetails=getFeedbackDetails,_this.feedbackEnable=!1,_this.formErrors={dateCheck:!1,emailCheck:!1,firstName:!1,lastName:!1},_this.showHideRequestFeedbackForm=showHideRequestFeedbackForm,_this.sendRequestFeedbackAdmin=sendRequestFeedbackAdmin,_this.deleteFeedback=deleteFeedback,_this.deleteConfirm=deleteConfirm,_this.sendReminder=sendReminder,_this.shrinkDt=shrinkDt,_this.loadTags=loadTags,_this.tagAdded=tagAdded,_this.tagRemoved=tagRemoved,_this.showNames=!1,_this.searchTag=[],_this.selectedUser={},_this.showRequestFeedbackForm=!1,_this.nameDataForm={},_this.feedbackDataResponse=!1,_this.winWidth=$(window).width(),_this.featuresSectionSelected=-1,_this.isId=void 0!==sharedProperties.getParam("feedbackId")&&null!==sharedProperties.getParam("feedbackId")&&""!==sharedProperties.getParam("feedbackId")?sharedProperties.getParam("feedbackId"):null}angular.module("spApp").controller("prismLensController",prismLensController),prismLensController.$inject=["$scope","ajaxService","$filter","ngDialog","sharedProperties","$rootScope","$timeout","$q","$localStorage"];