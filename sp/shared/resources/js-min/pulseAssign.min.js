angular.module("spApp").directive("pulseAssign",["ngDialog","sharedProperties","$rootScope","ajaxService","$filter",function(ngDialog,sharedProperties,$rootScope,ajaxService,$filter){return{restrict:"E",templateUrl:function(element,attrs){return"/sp/resources/html/sysAdmin/pulse/"+attrs.urlSrc},link:function(scope,element,attrs){var vm=scope,ids=(attrs.displayMode,sharedProperties.getParam("viewable"));vm.serviceApis={addToCompany:"/sp/sysAdmin/pulse/addToCompany",removeFromCompany:"/sp/sysAdmin/pulse/removeFromCompany",toggleForAll:"/sp/sysAdmin/pulse/toggleForAll",companyList:"/sp/sysAdmin/hk/getCompanyList",getDetails:"/sp/sysAdmin/pulse/getDetails"},vm.modalUrl={removeFromCompany:"/sp/resources/html/sysAdmin/pulse/dialog/remove-company.html",toggleAll:"/sp/resources/html/sysAdmin/pulse/dialog/toggle.html"},vm.companyList=[],vm.availableCompanyList=[],vm.pulseDetail=null,vm.pageSetting={pageSize:10,lastPredicate:"name",lastReverse:!1,disabledInfinite:!1,textSearching:""},vm.originalpageSetting=angular.copy(vm.pageSetting),vm.preview=!1,vm.addToCompany=function(param){ajaxService.getAjaxResponse({url:vm.serviceApis.addToCompany,data:$.param({pulseQuestionSetId:param.id,companyId:param.companyId})}).then(function(response){"true"===response.Success?(vm.pulseDetail.companys.push(param.company),vm.filterCompanyList()):null!=response.error&&sharedProperties.ajaxError(response.error)})},vm.removeFromCompanyDialog=function(param){vm.triggeredRequest=param,ngDialog.open({template:vm.modalUrl.removeFromCompany,scope:vm})},vm.removeFromCompany=function(param,arr){var companyId=param.companyId.map(function(e){return e.id});ajaxService.getAjaxResponse({url:vm.serviceApis.removeFromCompany,data:$.param({pulseQuestionSetId:param.id,companyIds:companyId.join(",")})}).then(function(response){if("true"===response.Success){for(var j=0;j<companyId.length;j++)for(var i=vm.pulseDetail.companys.length-1;i>=0;i--)if(vm.pulseDetail.companys[i].id===companyId[j]){vm.pulseDetail.companys.splice(i,1);break}ngDialog.close(),vm.filterCompanyList()}else null!=response.error&&(ngDialog.close(),sharedProperties.ajaxError(response.error))})},vm.toggleAllDialog=function(param){vm.triggeredRequest=param,ngDialog.open({template:vm.modalUrl.toggleAll,scope:vm})},vm.toggleAll=function(param){ajaxService.getAjaxResponse({url:vm.serviceApis.toggleForAll,data:$.param({pulseQuestionSetId:param.id})}).then(function(response){"true"===response.Success?(param.mode?(vm.pulseDetail.forAll=!0,sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.status.assigntoallaccount")),vm.pulseDetail.companys=[],vm.filterCompanyList()):(vm.pulseDetail.forAll=!1,sharedProperties.growlMessage($rootScope.pullInterNationalization("growl.status.removefromallaccount"))),ngDialog.close()):null!=response.error&&(ngDialog.close(),sharedProperties.ajaxError(response.error))})},vm.getCompanyList=function(){ajaxService.getAjaxResponse({url:vm.serviceApis.companyList,method:"GET"}).then(function(response){"true"===response.Success?(vm.companyList=response.companies,vm.filterCompanyList()):sharedProperties.ajaxError(response.error)})},vm.filterCompanyList=function(){null===vm.pulseDetail.companys&&(vm.pulseDetail.companys=[]),vm.pulseDetail.companys.length?vm.availableCompanyList=vm.companyList.filter(function(e){return!vm.pulseDetail.companys.filter(function(e1){return e1.id===e.id}).length}):vm.availableCompanyList=angular.copy(vm.companyList)},vm.getDetails=function(id){null===id&&vm.returnToList(),ajaxService.getAjaxResponse({url:vm.serviceApis.getDetails,data:$.param({pulseQuestionSetId:id})}).then(function(response){"true"===response.Success?(vm.pulseDetail=response.pulseQuestion,vm.getCompanyList()):null!=response.error&&sharedProperties.ajaxError(response.error)})},vm.returnToList=function(){window.location.href="/sp/sysAdmin/pulse/list"},vm.init=function(){vm.getDetails(ids)},vm.init()}}}]);