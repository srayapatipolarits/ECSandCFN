angular.module("spApp").directive("compareOverlayErti",["sharedProperties","$rootScope","ngDialog","$filter","$localStorage","$q","$timeout","$state","ajaxService",function(sharedProperties,$rootScope,ngDialog,$filter,$localStorage,$q,$timeout,$state,ajaxService){var compareOverlayErti={restrict:"EA",replace:!0,templateUrl:function(element,attrs){return"/sp/resources/html/admin/manage-account/"+attrs.urlSrc},link:function(scope,element,attrs){function matchSort(order){_this.memberList.sort(function(a,b){var af=a.matchResult.matchPercent,bf=b.matchResult.matchPercent;switch(order){case"asc":return af===bf?0:+(af>bf)||-1;case"dsc":return af===bf?0:+(af<bf)||-1}})}function compareOperation(){_this.returnMemberList(_this.pageSetting.pageSize),_this.responseReceived=!0}function init(){"dashboardGroups"===_this.compareType?(_this.masterMemberList=_this.parentScope.ctrl.memberList,_this.memberList=angular.copy(_this.masterMemberList),_this.filteredUsersList=angular.copy(_this.parentScope.ctrl.pageSetting.userEmail.email).map(function(e){return e.email}),compareOperation()):ajaxService.getAjaxResponse({url:"/sp/groupLead/getMemberPortraits",data:$.param({groupId:_this.compareId})}).then(function(response){if("true"===response.Success)_this.masterMemberList=response.groupList,_this.memberList=angular.copy(_this.masterMemberList),_this.filteredUsersList=angular.copy(_this.parentScope.ctrl.ps_pageSetting.userEmail.email).map(function(e){return e.email}),compareOperation();else if(null!==response.error)return sharedProperties.ajaxError(response.error),response})}var _this=scope;_this.parentScope=scope.$parent,_this.compareType=attrs.type,_this.compareId=attrs.id,_this.compareRoleId=null,_this.compareDetails={},_this.responseReceived=!1,_this.pageSetting={pageSize:12,lastPredicate:"name",lastReverse:!1,disabledInfinite:!1,textSearching:"",filterOptions:null},_this.originalpageSetting=angular.copy(_this.pageSetting),_this.gridLastCol=0,_this.gridClearCol=0,_this.gridUpdated=!1,_this.graphType=-1,_this.graphSelector=null,_this.motivationGraphType="why",_this.motivationGraphSelected="why",_this.graphLabelList={learning:[]},_this.filteredUsersList=[],_this.filteredRolesUsersList=[],function(){$(window).resize(function(){$timeout(function(){$(".roles-compare-view, .roles-compare-wrapper").css({"min-height":$(window).outerHeight()}),$(window).width()>=1400&&scope.$apply(function(){_this.gridLastCol=Math.floor($(".roles-compare-listing").outerWidth()/350),_this.gridClearCol=_this.gridLastCol+1}),$(window).width()<1400&&scope.$apply(function(){_this.gridLastCol=3,_this.gridClearCol=4}),$(window).width()<1107&&scope.$apply(function(){_this.gridLastCol=2,_this.gridClearCol=3})},100)})}(),_this.getGraphLabel=function(graphObj,memberId,graphType){"learning"===graphType&&(_this.graphLabelList.learning[memberId]=Object.keys(graphObj).reduce(function(a,b){return graphObj[a]>graphObj[b]?a:b}))},_this.customOrderBy=function(sort){switch(_this.pageSetting.textSearching="",sort){case"matchAO":matchSort("asc");break;case"matchDO":matchSort("dsc");break;case"nameDO":_this.order("name",!0);break;default:_this.pageSetting.filterOptions=null,_this.order("name",!1)}},_this.displayMotivationGraph=function(grpahType){_this.motivationGraphSelected=grpahType},_this.updateGraphs=function(id){"undefined"==typeof id||null===id||""===id?_this.graphType=-1:parseInt(id,10)!==_this.graphType&&(_this.graphType=parseInt(id,10)),_this.motivationGraphType="why",_this.motivationGraphSelected="why"},_this.updateCompareLayout=function(){$(".roles-compare-view, .roles-compare-wrapper").css({"min-height":$(window).outerHeight()}),$(window).width()<1400&&(_this.gridLastCol=3,_this.gridClearCol=4),$(window).width()<1107&&(_this.gridLastCol=2,_this.gridClearCol=3),$(window).width()>=1400&&(_this.gridLastCol=Math.floor($(".roles-compare-listing").outerWidth()/335),_this.gridClearCol=_this.gridLastCol+1)},_this.order=function(predicate,reverse){_this.pageSetting.lastPredicate=predicate,_this.pageSetting.lastReverse=reverse;var orderedList=$filter("orderBy")(_this.memberList,_this.pageSetting.lastPredicate,_this.pageSetting.lastReverse);_this.memberList=function(array,key){if("name"===key){for(var list=[],empty=[],i=0;i<array.length;i++)null!==array[i][key]&&""!==array[i][key]&&"undefined"!=typeof array[i][key]?list.push(array[i]):empty.push(array[i]);return $.merge(list,empty)}return orderedList}(orderedList,_this.pageSetting.lastPredicate)},_this.active=function(event,setting){_this.pageSetting.lastPredicate=setting.predicate,_this.pageSetting.lastReverse=setting.reverse,sharedProperties.toggleFilterClick(event,_this.pageSetting.lastPredicate),_this.order(_this.pageSetting.lastPredicate,_this.pageSetting.lastReverse)},_this.infinteScroll=function(pageSize){_this.pageSetting.disabledInfinite||(_this.pageSetting.pageSize=pageSize,pageSize>=_this.masterMemberList.length&&(_this.pageSetting.disabledInfinite=!0,_this.pageSetting.pageSize=_this.masterMemberList.length)),$timeout(function(){_this.updateCompareLayout()},200)},_this.returnMemberList=function(){if(!_this.masterMemberList.length)return!0;_this.pageSetting.pageSize=_this.originalpageSetting.pageSize,_this.pageSetting.disabledInfinite=!1;var result=_this.masterCopy?_this.masterMemberList:_this.memberList;"dashboardGroups"===_this.compareType?_this.memberList=result.filter(function(e){return"VALID"===e.userStatus&&_this.filteredUsersList.indexOf(e.email)!==-1&&sharedProperties.singleElementSearch(_this.pageSetting.textSearching,e,2)}):_this.memberList=result.filter(function(e){return _this.filteredUsersList.indexOf(e.email)!==-1&&sharedProperties.singleElementSearch(_this.pageSetting.textSearching,e,2)}),_this.order(_this.pageSetting.lastPredicate,_this.pageSetting.lastReverse),_this.masterCopy=!0,$timeout(function(){_this.updateCompareLayout()},200)},_this.closeRolesCompareView=function(){ngDialog.closeAll(),"roles"===_this.compareType&&($localStorage.set("selectedRoleId",_this.compareRoleId),$state.transitionTo("roleDetails",{id:_this.compareRoleId},{reload:!0}))},init(_this.compareType)}};return compareOverlayErti}]);