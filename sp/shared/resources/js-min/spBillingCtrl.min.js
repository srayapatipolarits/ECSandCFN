function spBillingCtrl($scope,$http,$element,$attrs,ajaxService,$location,$state,$localStorage,sharedProperties,$timeout,ngDialog,$q,$rootScope){function getTotalPrice(priceObj){return null!==priceObj.unitPrice&&void 0!==priceObj.unitPrice&&0!==priceObj.unitPrice?parseFloat(priceObj.unitPrice*priceObj.noOfAccounts).toFixed(2):parseFloat(priceObj.overridePrice).toFixed(2)}function getPrimaryDetails(type,plan){var count=0,planData="Primary"===plan?_this.planDetailsPrimary.updateDetails:_this.planDetailsHiring.updateDetails;if("Members"===type)for(var i=0;i<planData.length;i++)"PlanMember"===planData[i].accountUpdateType&&(planData[i].overridePrice>0?count+=planData[i].overridePrice:count+=planData[i].unitPrice*planData[i].noOfAccounts);else if("Admins"===type)for(var j=0;j<planData.length;j++)"PlanAdmin"===planData[j].accountUpdateType&&(planData[j].overridePrice>0?count+=planData[j].overridePrice:count+=planData[j].unitPrice*planData[j].noOfAccounts);return count}function getDetails(type,plan){_this.getDetailsType=type,_this.getDetailsPlanType=plan,ngDialog.open({template:"/sp/resources/html/sysAdmin/alternateBilling/memberDetails.html",scope:$scope})}function processCredit(){_this.creditErrors=null,_this.creditFormSubmit=!1,_this.creditSubmitErrors=!1,_this.addCreditForm.$valid?ajaxService.getAjaxResponse({url:_this.services.addCredit,data:$.param({accountId:_this.accountId,chargeAmount:_this.creditInfo.amount,paymentType:_this.creditInfo.cpt,comment:_this.creditInfo.ccomment,spPlanType:_this.currentPlanInfo.planType})}).then(function(response){if("true"===response.Success)"Primary"===_this.currentPlanInfo.planType?_this.billingStep2Details.creditBalance+=_this.creditInfo.amount:"IntelligentHiring"===_this.currentPlanInfo.planType&&(_this.billingStep2HiringDetails.creditBalance+=_this.creditInfo.amount),_this.currentPlanInfo={},ngDialog.close("ngdialog1"),sharedProperties.growlMessage($rootScope.pullInterNationalization("billing.amoutcred"));else if(null!==response.error){var errorMessage="";for(var key in response.error)errorMessage=response.error[key];_this.creditSubmitErrors=!0,_this.creditErrors=errorMessage}}):_this.creditFormSubmit=!0}function showAddCredit(planType){_this.creditFormSubmit=!1,_this.creditInfo={},_this.currentPlanInfo={planType:planType,term:_this.planDetails[planType].agreementTerm,paymentType:_this.planDetails[planType].paymentType,expiry:_this.planDetails[planType].planInfo.expiresTime,balance:_this.planDetails[planType].creditBalance},ngDialog.open({template:_this.dialogTemplates.addCredit,scope:$scope})}function updateRemainingDays(days){var totalMonths=Math.floor(days/30),totalDays=days%30;return totalMonths>=1?totalMonths+" Months "+totalDays+" Days":"0 Months "+totalDays+" Days"}function validateBeforeSubmit(){"create"===_this.step2Mode&&(_this.billingStep2Details.Primary||_this.billingStep2Details.IntelligentHiring)?_this.processBillingStep2():"edit"===_this.step2Mode&&_this.processBillingStep2()}function getAccountDetails(id){var showTab=sharedProperties.getParam("showTab");ajaxService.getAjaxResponse({url:_this.services.accountDetails,data:$.param({accountId:id,isEditAccountRequest:!0})}).then(function(response){"true"===response.Success?(_this.accountDetails=response.account,_this.companyDetails=response.company,_this.planDetails=response.account.spPlans,"Primary"in _this.planDetails&&(_this.planDetailsPrimary=_this.planDetails.Primary,_this.primaryPlanAvailable=!0,_this.primaryPlanActive=_this.planDetails.Primary.active,_this.billingStep2Details.name=_this.planDetails.Primary.planName,_this.billingStep2Details.enhancedPasswordSecurity=_this.companyDetails.enhancePasswordSecurity,_this.billingStep2Details.aggreementTerm=void 0!==_this.planDetails.Primary.agreementTerm&&null!==_this.planDetails.Primary.agreementTerm&&""!==_this.planDetails.Primary.agreementTerm&&_this.planDetails.Primary.agreementTerm>0?_this.planDetails.Primary.agreementTerm.toString():"",_this.billingStep2Details.spPlanLicensePrice=_this.planDetails.Primary.licensePrice,_this.billingStep2Details.numAdmin=_this.planDetails.Primary.availalbeAdminSubscriptions,_this.billingStep2Details.unitAdminPrice=_this.planDetails.Primary.unitAdminPrice,_this.billingStep2Details.isOverrideAdminAmount=_this.planDetails.Primary.overrideAdminPrice>0,_this.billingStep2Details.overrideAdminPrice=_this.planDetails.Primary.overrideAdminPrice,_this.billingStep2Details.numCandidates=_this.planDetails.Primary.availalbeMemberSubscriptions,_this.billingStep2Details.pricePerCandidate=_this.planDetails.Primary.unitMemberPrice,_this.billingStep2Details.isOverrideAmount=!!_this.planDetails.Primary.overrideMemberPrice,_this.billingStep2Details.overrideCandidatePrice=_this.planDetails.Primary.overrideMemberPrice,_this.billingStep2Details.paymentType=_this.planDetails.Primary.paymentType,_this.billingStep2Details.billingCycle=_this.planDetails.Primary.planInfo.planBillingCycleType,_this.billingStep2Details.creditBalance=_this.planDetails.Primary.creditBalance?_this.planDetails.Primary.creditBalance:0,_this.billingStep2Details.primaryFeaturesList=_this.planDetails.Primary.features,_this.editPrimaryFeatures=_this.planDetails.Primary.features,_this.planFeaturesList=[],_this.planFeaturesList=angular.copy(_this.planDetails.Primary.features),_this.billingStep2Details.tags=_this.planDetails.Primary.tagsKeywords.length?_this.planDetails.Primary.tagsKeywords.map(function(e){return{text:e}}):[],"Custom"===_this.billingStep2Details.billingCycle&&(_this.billingStep2Details.noOfMonths=_this.planDetails.Primary.planInfo.planBillingCycle),_this.updatePricing("primary")),"IntelligentHiring"in _this.planDetails&&(_this.hiringPlanAvailable=!0,_this.planDetailsHiring=_this.planDetails.IntelligentHiring,_this.hiringPlanActive=_this.planDetails.IntelligentHiring.active,_this.billingStep2Details.name=_this.planDetails.IntelligentHiring.planName,_this.billingStep2HiringDetails.enhancedPasswordSecurity=_this.companyDetails.enhancePasswordSecurity,_this.billingStep2HiringDetails.aggreementTerm=void 0!==_this.planDetails.IntelligentHiring.agreementTerm&&null!==_this.planDetails.IntelligentHiring.agreementTerm&&""!==_this.planDetails.IntelligentHiring.agreementTerm&&_this.planDetails.IntelligentHiring.agreementTerm>0?_this.planDetails.IntelligentHiring.agreementTerm.toString():"",_this.billingStep2HiringDetails.spPlanLicensePrice=_this.planDetails.IntelligentHiring.licensePrice,_this.billingStep2HiringDetails.numAdmin=_this.planDetails.IntelligentHiring.availalbeAdminSubscriptions,_this.billingStep2HiringDetails.unitAdminPrice=_this.planDetails.IntelligentHiring.unitAdminPrice,_this.billingStep2HiringDetails.isOverrideAdminAmount=_this.planDetails.IntelligentHiring.overrideAdminPrice>0,_this.billingStep2HiringDetails.overrideAdminPrice=_this.planDetails.IntelligentHiring.overrideAdminPrice,_this.billingStep2HiringDetails.numCandidates=_this.planDetails.IntelligentHiring.availalbeMemberSubscriptions,_this.billingStep2HiringDetails.pricePerCandidate=_this.planDetails.IntelligentHiring.unitMemberPrice,_this.billingStep2HiringDetails.isOverrideAmount=!!_this.planDetails.IntelligentHiring.overrideMemberPrice,_this.billingStep2HiringDetails.overrideCandidatePrice=_this.planDetails.IntelligentHiring.overrideMemberPrice,_this.billingStep2HiringDetails.paymentType=_this.planDetails.IntelligentHiring.paymentType,_this.billingStep2HiringDetails.billingCycle=_this.planDetails.IntelligentHiring.planInfo.planBillingCycleType,_this.billingStep2HiringDetails.creditBalance=_this.planDetails.IntelligentHiring.creditBalance?_this.planDetails.IntelligentHiring.creditBalance:0,_this.billingStep2HiringDetails.isBundle=_this.planDetails.IntelligentHiring.bundle,_this.billingStep2HiringDetails.isBundle?(_this.billingStep2HiringDetails.numBundles=parseInt(_this.billingStep2HiringDetails.numCandidates/_this.bundleMultiplier,10)<1?1:parseInt(_this.billingStep2HiringDetails.numCandidates/_this.bundleMultiplier,10),_this.billingStep2HiringDetails.pricePerBundle=parseInt(_this.billingStep2HiringDetails.pricePerCandidate*_this.bundleMultiplier,10)):$timeout(function(){$("#noBundle").prop("checked",!0)},200),"Custom"===_this.billingStep2HiringDetails.billingCycle&&(_this.billingStep2HiringDetails.noOfMonths=_this.planDetails.IntelligentHiring.planInfo.planBillingCycle),_this.billingStep2HiringDetails.tags=_this.planDetails.IntelligentHiring.tagsKeywords.length?_this.planDetails.IntelligentHiring.tagsKeywords.map(function(e){return{text:e}}):[],_this.updatePricing("hiring")),"edit"===_this.step2Mode&&!_this.primaryPlanAvailable&&_this.hiringPlanAvailable?(_this.billingStep2Details.Primary=!1,_this.ignoreErtiForm=!0,_this.disableErtiForm=!0,$timeout(function(){_this.updateFormView("IntelligentHiring")},100)):"edit"===_this.step2Mode&&_this.primaryPlanAvailable&&!_this.hiringPlanAvailable&&(_this.billingStep2Details.IntelligentHiring=!1,_this.ignoreHiringForm=!0,_this.disableHiringForm=!0,$timeout(function(){_this.updateFormView("Primary")},100)),null!==showTab&&void 0!==showTab&&$timeout(function(){_this.viewForm=showTab},105),_this.generateTagsList()):null!==response.error&&(sharedProperties.ajaxError(response.error),$timeout(function(){_this.pageRedirect()},3e3))})}function updateBundles(flag){_this.billingStep2HiringDetails.isBundle=flag,_this.billingStep2HiringDetails.numBundles=0,_this.billingStep2HiringDetails.numCandidates=0,_this.billingStep2HiringDetails.pricePerCandidate=0,_this.billingStep2HiringDetails.pricePerBundle=0,_this.billingStep2HiringDetails.overrideCandidatePrice=0}function pageRedirect(){window.location.href="/sp/sysAdmin/alternateBilling/business"}function resetForm(id){_this.isMemberSelect=!1,_this.inputRequired=!1,_this.disableEmail=!1,_this.disableEmailHiring=!1,_this.emailMemberList=[],_this.companyList=[],_this.tags=[],_this.searchTag=[],_this.storeCompany={},_this.searchText="",$(id).find("select, input[type='text']:not(.no-reset), input[type='number']:not(.no-reset)").val(""),$(id).find("input[type='radio']:not(.no-reset), input[type='checkbox']:not(.no-reset)").prop("checked",""),_this.step2Submited=!1,_this.disableErtiOpt||(_this.agreementTotalPrice=0,_this.monthlyPlatformLicensePrice=0,_this.monthlyAdminPrice=0,_this.monthlyMemberPrice=0,_this.billingStep2Details.chargeAmount=0,_this.billingStep2Details.primaryFeaturesList="",_this.billingStep2Details.isOverrideAmount=!1,_this.billingStep2Details.isOverrideAdminAmount=!1,_this.billingStep2Details.tags="",_this.billingStep2Details.firstName="",_this.billingStep2Details.lastName="",_this.billingStep2Details.title="",_this.billingStep2Details.email="",_this.billingStep2Details.confirmEmail="",_this.billingStep2Details.existingMember=!1),_this.disableHiringOpt||(_this.billingStep2HiringDetails.isOverrideAmount=!1,_this.billingStep2HiringDetails.isOverrideAdminAmount=!1,_this.billingStep2HiringDetails.tags="",_this.billingStep2HiringDetails.isBundle=!0,_this.billingStep2HiringDetails.firstName="",_this.billingStep2HiringDetails.lastName="",_this.billingStep2HiringDetails.title="",_this.billingStep2HiringDetails.email="",_this.billingStep2HiringDetails.confirmEmail="",_this.billingStep2HiringDetails.existingMember=!1,_this.agreementTotalPriceHiring=0,_this.monthlyPlatformLicensePriceHiring=0,_this.monthlyAdminPriceHiring=0,_this.monthlyMemberPriceHiring=0)}function processHashParams(){var hashParams=window.location.hash;_this.step2Mode=hashParams&&void 0!==hashParams&&null!==hashParams&&""!==hashParams?hashParams.split("mode=")[1].split("&planList=")[0]:"create",_this.step2planList="create"!==_this.step2Mode&&hashParams&&void 0!==hashParams&&null!==hashParams&&""!==hashParams?hashParams.split("mode=")[1].split("&planList=")[1].replace("%22","").split(","):["Primary"],"create"===_this.step2Mode?_this.changeTabs():"create"!==_this.step2Mode&&-1!==_this.step2planList.indexOf("Primary")&&1===_this.step2planList.length?(_this.billingStep2Details.Primary=!0,_this.disableErtiOpt=!0,_this.disableHiringOpt=!1,_this.ignoreErtiForm=!1,_this.disableErtiForm=!1,_this.submitDisable=!1,_this.viewForm="Primary"):"create"!==_this.step2Mode&&-1!==_this.step2planList.indexOf("IntelligentHiring")&&1===_this.step2planList.length?(_this.billingStep2Details.IntelligentHiring=!0,_this.disableErtiOpt=!1,_this.disableHiringOpt=!0,_this.ignoreHiringForm=!1,_this.disableHiringForm=!1,_this.submitDisable=!1,_this.viewForm="IntelligentHiring"):"create"!==_this.step2Mode&&_this.step2planList.length>1&&(_this.billingStep2Details.Primary=!0,_this.billingStep2Details.IntelligentHiring=!0,_this.disableErtiOpt=!0,_this.disableHiringOpt=!0,_this.ignoreErtiForm=!1,_this.disableErtiForm=!1,_this.ignoreHiringForm=!1,_this.disableHiringForm=!1,_this.submitDisable=!1,_this.viewForm="Primary")}function updateFormView(vName){"create"===_this.step2Mode?(_this.disableErtiOpt||"Primary"===_this.viewForm||_this.viewForm!==vName&&(_this.viewForm=vName),_this.disableHiringOpt||"IntelligentHiring"===_this.viewForm||_this.viewForm!==vName&&(_this.viewForm=vName)):"edit"===_this.step2Mode&&(_this.viewForm!==vName&&(_this.viewForm=vName),_this.disableErtiOpt&&!_this.disableHiringOpt&&"IntelligentHiring"!==_this.viewForm&&(_this.billingStep2Details.IntelligentHiring=!1,_this.ignoreHiringForm=!0,_this.disableHiringForm=!0),!_this.disableErtiOpt&&_this.disableHiringOpt&&"Primary"!==_this.viewForm&&(_this.billingStep2Details.Primary=!1,_this.ignoreErtiForm=!0,_this.disableErtiForm=!0))}function changeTabs(name){switch(name){case"Primary":"create"===_this.step2Mode?_this.disableErtiOpt||(_this.billingStep2Details.Primary?($timeout(function(){_this.resetForm("#formPrimary"),_this.ignoreErtiForm=!1,_this.disableErtiForm=!1,_this.submitDisable=!1},200),_this.disableHiringOpt=!0):($timeout(function(){_this.resetForm("#formPrimary"),_this.ignoreErtiForm=!0,_this.disableErtiForm=!0,_this.submitDisable=!0},200),_this.disableHiringOpt=!1)):"edit"===_this.step2Mode&&(_this.disableErtiOpt||(_this.billingStep2Details.Primary?$timeout(function(){_this.resetForm("#formPrimary"),_this.ignoreErtiForm=!1,_this.disableErtiForm=!1},200):$timeout(function(){_this.resetForm("#formPrimary"),_this.ignoreErtiForm=!0,_this.disableErtiForm=!0},200)));break;case"IntelligentHiring":"create"===_this.step2Mode?_this.disableHiringOpt||(_this.billingStep2Details.IntelligentHiring?($timeout(function(){_this.resetForm("#formIntelligentHiring"),_this.ignoreHiringForm=!1,_this.disableHiringForm=!1,_this.submitDisable=!1},200),_this.disableErtiOpt=!0):($timeout(function(){_this.resetForm("#formIntelligentHiring"),_this.ignoreHiringForm=!0,_this.disableHiringForm=!0,_this.submitDisable=!0},200),_this.disableErtiOpt=!1)):"edit"===_this.step2Mode&&(_this.disableHiringOpt||(_this.billingStep2Details.IntelligentHiring?$timeout(function(){_this.resetForm("#formIntelligentHiring"),_this.ignoreHiringForm=!1,_this.disableHiringForm=!1},200):$timeout(function(){_this.resetForm("#formIntelligentHiring"),_this.ignoreHiringForm=!0,_this.disableHiringForm=!0},200)));break;default:_this.submitDisable=!0,_this.disableHiringOpt=!1,_this.disableErtiOpt=!1,_this.viewForm="Primary"}}function initStep2(){_this.processHashParams(),_this.getFeatures(),_this.accountId=sharedProperties.getParam("accountId"),null!==_this.accountId&&_this.getAccountDetails(_this.accountId)}function generateTagsList(){$timeout(function(){void 0!==_this.billingStep2Details.tags&&null!==_this.billingStep2Details.tags&&_this.billingStep2Details.tags.length>0?_this.billingStep2Details.tagsList=_this.billingStep2Details.tags.map(function(e){return e.text}).toString():_this.billingStep2Details.tagsList="",void 0!==_this.billingStep2HiringDetails.tags&&null!==_this.billingStep2HiringDetails.tags&&_this.billingStep2HiringDetails.tags.length>0?_this.billingStep2HiringDetails.tagsList=_this.billingStep2HiringDetails.tags.map(function(e){return e.text}).toString():_this.billingStep2HiringDetails.tagsList=""},100)}function loadTags(query){var deferred=$q.defer(),result=_this.emailMemberList.filter(function(e){return-1!==e.name.toLowerCase().indexOf(query.toLowerCase())||-1!==e.email.toLowerCase().indexOf(query.toLowerCase())});return deferred.resolve(result),deferred.promise}function tagAdded(tag){_this.searchTag.push(tag.email),-1!==tag.roles.indexOf(_this.selectedRole)?_this.inputRequired=!0:(_this.inputRequired=!1,_this.selectedUser=tag)}function tagRemoved(tag){_this.selectedUser=null,_this.inputRequired=!1,_this.searchTag.splice(_this.searchTag.indexOf(tag.email),1)}function updateSelectedMember(userObj){"Primary"===_this.viewForm?(_this.billingStep2Details.firstName=userObj.firstName,_this.billingStep2Details.lastName=userObj.lastName,_this.billingStep2Details.title=userObj.title,_this.billingStep2Details.email=userObj.email,_this.billingStep2Details.confirmEmail=userObj.email,_this.billingStep2Details.existingMember=!0,_this.disableEmail=!0,_this.disableEmailHiring=!1):(_this.billingStep2HiringDetails.firstName=userObj.firstName,_this.billingStep2HiringDetails.lastName=userObj.lastName,_this.billingStep2HiringDetails.title=userObj.title,_this.billingStep2HiringDetails.email=userObj.email,_this.billingStep2HiringDetails.confirmEmail=userObj.email,_this.billingStep2HiringDetails.existingMember=!0,_this.disableEmail=!1,_this.disableEmailHiring=!0),ngDialog.close("ngdialog1"),sharedProperties.growlMessage($rootScope.pullInterNationalization("billing.membersAdd"))}function getAllMembers(id,name,city,country){_this.isCompanySelect=!1,_this.storeCompany={name:name,city:city,country:country},ajaxService.getAjaxResponse({url:_this.services.existingMember,data:$.param({companyId:id})}).then(function(response){"true"===response.Success?(_this.isMemberSelect=!0,_this.emailMemberList=response.memberList):null!=response.error&&(ngDialog.close("ngdialog1"),sharedProperties.ajaxError(response.error))})}function getExistingMember(role){_this.isCompanySelect=!0,_this.isMemberSelect=!1,_this.inputRequired=!1,_this.disableEmail=!1,_this.emailMemberList=[],_this.companyList=[],_this.tags=[],_this.searchTag=[],_this.storeCompany={},_this.searchText="",_this.selectedRole=role,ajaxService.getAjaxResponse({url:_this.services.allCompanies,method:"GET"}).then(function(response){"true"===response.Success?(_this.companyList=response.companies,ngDialog.open({template:_this.dialogTemplates.existingMember,scope:$scope})):null!=response.error&&(ngDialog.close("ngdialog1"),sharedProperties.ajaxError(response.error))})}function updateFeatureSelection(name){var i=_this.planFeaturesList.indexOf(name);i>-1?_this.planFeaturesList.splice(i,1):_this.planFeaturesList.push(name),_this.billingStep2Details.primaryFeaturesList=_this.planFeaturesList.toString()}function updatePricing(plan){"primary"===plan?(_this.agreementTotalPrice=0,_this.monthlyPlatformLicensePrice=0,_this.monthlyAdminPrice=0,_this.monthlyMemberPrice=0,_this.billingStep2Details.chargeAmount=0,_this.monthlyPlatformLicensePrice=parseFloat(_this.billingStep2Details.spPlanLicensePrice?_this.billingStep2Details.spPlanLicensePrice:0).toFixed(2),_this.billingStep2Details.isOverrideAdminAmount?(_this.monthlyAdminPrice=parseFloat(_this.billingStep2Details.overrideAdminPrice?_this.billingStep2Details.overrideAdminPrice:0).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.primaryPlanAvailable)&&(_this.billingStep2Details.unitAdminPrice=0)):(_this.monthlyAdminPrice=parseFloat((_this.billingStep2Details.numAdmin?_this.billingStep2Details.numAdmin:0)*(_this.billingStep2Details.unitAdminPrice?_this.billingStep2Details.unitAdminPrice:0)).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.primaryPlanAvailable)&&(_this.billingStep2Details.overrideAdminPrice=0)),_this.billingStep2Details.isOverrideAmount?(_this.monthlyMemberPrice=parseFloat(_this.billingStep2Details.overrideCandidatePrice?_this.billingStep2Details.overrideCandidatePrice:0).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.primaryPlanAvailable)&&(_this.billingStep2Details.pricePerCandidate=0)):(_this.monthlyMemberPrice=parseFloat((_this.billingStep2Details.numCandidates?_this.billingStep2Details.numCandidates:0)*(_this.billingStep2Details.pricePerCandidate?_this.billingStep2Details.pricePerCandidate:0)).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.primaryPlanAvailable)&&(_this.billingStep2Details.overrideCandidatePrice=0)),_this.agreementTotalPrice=Math.round(parseFloat(_this.monthsInYear*parseInt(_this.billingStep2Details.aggreementTerm?_this.billingStep2Details.aggreementTerm:0,10)*(parseFloat(_this.monthlyPlatformLicensePrice)+parseFloat(_this.monthlyAdminPrice)+parseFloat(_this.monthlyMemberPrice))).toFixed(2)),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.primaryPlanAvailable)&&(_this.billingStep2Details.billingCycle&&"Custom"!==_this.billingStep2Details.billingCycle?_this.billingStep2Details.billingCycleTotal=_this.billingStep2Details.chargeAmount=Math.round((billingCycleMonths[_this.billingStep2Details.billingCycle.toLowerCase().replace("-","")]?billingCycleMonths[_this.billingStep2Details.billingCycle.toLowerCase().replace("-","")]:0)*(parseFloat(_this.monthlyPlatformLicensePrice)+parseFloat(_this.monthlyAdminPrice)+parseFloat(_this.monthlyMemberPrice))):_this.billingStep2Details.billingCycle&&"Custom"===_this.billingStep2Details.billingCycle&&(_this.billingStep2Details.billingCycleTotal=_this.billingStep2Details.chargeAmount=Math.round((parseInt(_this.billingStep2Details.noOfMonths,10)?parseInt(_this.billingStep2Details.noOfMonths,10):0)*(parseFloat(_this.monthlyPlatformLicensePrice)+parseFloat(_this.monthlyAdminPrice)+parseFloat(_this.monthlyMemberPrice)))))):(_this.agreementTotalPriceHiring=0,_this.monthlyPlatformLicensePriceHiring=0,_this.monthlyAdminPriceHiring=0,_this.monthlyMemberPriceHiring=0,_this.billingStep2HiringDetails.chargeAmount=0,_this.monthlyPlatformLicensePriceHiring=parseFloat(_this.billingStep2HiringDetails.spPlanLicensePrice?_this.billingStep2HiringDetails.spPlanLicensePrice:0).toFixed(2),_this.billingStep2HiringDetails.isOverrideAdminAmount?(_this.monthlyAdminPriceHiring=parseFloat(_this.billingStep2HiringDetails.overrideAdminPrice?_this.billingStep2HiringDetails.overrideAdminPrice:0).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.hiringPlanAvailable)&&(_this.billingStep2HiringDetails.unitAdminPrice=0)):(_this.monthlyAdminPriceHiring=parseFloat((_this.billingStep2HiringDetails.numAdmin?_this.billingStep2HiringDetails.numAdmin:0)*(_this.billingStep2HiringDetails.unitAdminPrice?_this.billingStep2HiringDetails.unitAdminPrice:0)).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.hiringPlanAvailable)&&(_this.billingStep2HiringDetails.overrideAdminPrice=0)),_this.billingStep2HiringDetails.isOverrideAmount?(_this.monthlyMemberPriceHiring=parseFloat(_this.billingStep2HiringDetails.overrideCandidatePrice?_this.billingStep2HiringDetails.overrideCandidatePrice:0).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.hiringPlanAvailable)&&(_this.billingStep2HiringDetails.pricePerCandidate=0,_this.billingStep2HiringDetails.pricePerBundle=0),_this.billingStep2HiringDetails.isBundle&&(_this.billingStep2HiringDetails.numCandidates=Number(parseInt(_this.billingStep2HiringDetails.numBundles*_this.bundleMultiplier,10)))):_this.billingStep2HiringDetails.isBundle?(_this.monthlyMemberPriceHiring=parseFloat((_this.billingStep2HiringDetails.numBundles?_this.billingStep2HiringDetails.numBundles:0)*(_this.billingStep2HiringDetails.pricePerBundle?_this.billingStep2HiringDetails.pricePerBundle:0)).toFixed(2),_this.billingStep2HiringDetails.pricePerCandidate=Number(parseFloat(_this.billingStep2HiringDetails.pricePerBundle/_this.bundleMultiplier).toFixed(2)),_this.billingStep2HiringDetails.numCandidates=Number(parseInt(_this.billingStep2HiringDetails.numBundles*_this.bundleMultiplier,10))):(_this.monthlyMemberPriceHiring=parseFloat((_this.billingStep2HiringDetails.numCandidates?_this.billingStep2HiringDetails.numCandidates:0)*(_this.billingStep2HiringDetails.pricePerCandidate?_this.billingStep2HiringDetails.pricePerCandidate:0)).toFixed(2),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.hiringPlanAvailable)&&(_this.billingStep2HiringDetails.overrideCandidatePrice=0)),_this.agreementTotalPriceHiring=Math.round(parseFloat(_this.monthsInYear*parseInt(_this.billingStep2HiringDetails.aggreementTerm?_this.billingStep2HiringDetails.aggreementTerm:0,10)*(parseFloat(_this.monthlyPlatformLicensePriceHiring)+parseFloat(_this.monthlyAdminPriceHiring))+parseFloat(_this.monthlyMemberPriceHiring)).toFixed(2)),("create"===_this.step2Mode||"edit"===_this.step2Mode&&!_this.hiringPlanAvailable)&&(_this.billingStep2HiringDetails.billingCycle&&"Custom"!==_this.billingStep2HiringDetails.billingCycle?(_this.billingStep2HiringDetails.chargeAmount=Math.round((billingCycleMonths[_this.billingStep2HiringDetails.billingCycle.toLowerCase().replace("-","")]?billingCycleMonths[_this.billingStep2HiringDetails.billingCycle.toLowerCase().replace("-","")]:0)*(parseFloat(_this.monthlyPlatformLicensePriceHiring)+parseFloat(_this.monthlyAdminPriceHiring))+parseFloat(_this.monthlyMemberPriceHiring)),_this.billingStep2HiringDetails.billingCycleTotal=Math.round((billingCycleMonths[_this.billingStep2HiringDetails.billingCycle.toLowerCase().replace("-","")]?billingCycleMonths[_this.billingStep2HiringDetails.billingCycle.toLowerCase().replace("-","")]:0)*(parseFloat(_this.monthlyPlatformLicensePriceHiring)+parseFloat(_this.monthlyAdminPriceHiring)))):_this.billingStep2HiringDetails.billingCycle&&"Custom"===_this.billingStep2HiringDetails.billingCycle&&(_this.billingStep2HiringDetails.chargeAmount=Math.round((parseInt(_this.billingStep2HiringDetails.noOfMonths,10)?parseInt(_this.billingStep2HiringDetails.noOfMonths,10):0)*(parseFloat(_this.monthlyPlatformLicensePriceHiring)+parseFloat(_this.monthlyAdminPriceHiring))+parseFloat(_this.monthlyMemberPriceHiring)),_this.billingStep2HiringDetails.billingCycleTotal=Math.round((parseInt(_this.billingStep2HiringDetails.noOfMonths,10)?parseInt(_this.billingStep2HiringDetails.noOfMonths,10):0)*(parseFloat(_this.monthlyPlatformLicensePriceHiring)+parseFloat(_this.monthlyAdminPriceHiring)))))),_this.updateProRatedPricing()}function updateProRatedPricing(){if("edit"===_this.step2Mode&&_this.hiringPlanAvailable&&"IntelligentHiring"===_this.viewForm){var procAdminAmount=0,splHiringPriceCharge=0;if(_this.billingStep2HiringDetails.chargeAmount=0,_this.billingStep2HiringDetails.spPlanLicensePrice>_this.planDetailsHiring.licensePrice){var splHiringPrice=parseFloat((_this.billingStep2HiringDetails.spPlanLicensePrice-_this.planDetailsHiring.licensePrice)/daysInMonth*(_this.planDetailsHiring.remainingChargableDays/daysInMonth)).toFixed(2);splHiringPriceCharge=splHiringPrice?parseFloat(splHiringPrice).toFixed(2):0}if(_this.billingStep2HiringDetails.isOverrideAdminAmount){var overridecAdminCharge=parseFloat((_this.billingStep2HiringDetails.overrideAdminPrice-_this.planDetailsHiring.planAdminNextChargeAmount)*(_this.planDetailsHiring.remainingChargableDays/daysInMonth)).toFixed(2);procAdminAmount=overridecAdminCharge<0?0:parseFloat(overridecAdminCharge).toFixed(2)}else _this.billingStep2HiringDetails.numAdmin>_this.planDetailsHiring.availalbeAdminSubscriptions&&(procAdminAmount=parseFloat(_this.planDetailsHiring.unitAdminPrice/daysInMonth*(_this.billingStep2HiringDetails.numAdmin-_this.planDetailsHiring.availalbeAdminSubscriptions)*_this.planDetailsHiring.remainingChargableDays).toFixed(2));_this.billingStep2HiringDetails.chargeAmount=Math.round(parseFloat(splHiringPriceCharge)+parseFloat(procAdminAmount)),"Custom"!==_this.billingStep2HiringDetails.billingCycle?_this.billingStep2HiringDetails.billingCycleTotal=Math.round((billingCycleMonths[_this.billingStep2HiringDetails.billingCycle.toLowerCase().replace("-","")]?billingCycleMonths[_this.billingStep2HiringDetails.billingCycle.toLowerCase().replace("-","")]:0)*(parseFloat(_this.monthlyPlatformLicensePriceHiring)+parseFloat(_this.monthlyAdminPriceHiring))):_this.billingStep2HiringDetails.billingCycleTotal=Math.round((parseInt(_this.billingStep2HiringDetails.noOfMonths,10)?parseInt(_this.billingStep2HiringDetails.noOfMonths,10):0)*(parseFloat(_this.monthlyPlatformLicensePriceHiring)+parseFloat(_this.monthlyAdminPriceHiring)))}else if("edit"===_this.step2Mode&&_this.primaryPlanAvailable&&"Primary"===_this.viewForm){var proMemAmount=0,proAdminAmount=0,splErtiPrice=0;if(_this.billingStep2Details.chargeAmount=0,_this.billingStep2Details.spPlanLicensePrice>_this.planDetailsPrimary.licensePrice){var splErtiPriceCharge=parseFloat((_this.billingStep2Details.spPlanLicensePrice-_this.planDetailsPrimary.licensePrice)/daysInMonth*(_this.planDetailsPrimary.remainingChargableDays/daysInMonth)).toFixed(2);splErtiPrice=splErtiPriceCharge<0?0:parseFloat(splErtiPriceCharge).toFixed(2)}if(_this.billingStep2Details.isOverrideAmount){var overrideMemCharge=parseFloat((_this.planDetailsPrimary.planMemberNextChargeAmount-_this.billingStep2Details.overrideCandidatePrice)*(_this.planDetailsPrimary.remainingChargableDays/daysInMonth)).toFixed(2);proMemAmount=overrideMemCharge<0?0:parseFloat(overrideMemCharge).toFixed(2)}else _this.billingStep2Details.numCandidates>_this.planDetailsPrimary.availalbeMemberSubscriptions&&(proMemAmount=parseFloat(_this.planDetailsPrimary.unitMemberPrice/daysInMonth*(_this.billingStep2Details.numCandidates-_this.planDetailsPrimary.availalbeMemberSubscriptions)*_this.planDetailsPrimary.remainingChargableDays).toFixed(2));if(_this.billingStep2Details.isOverrideAdminAmount){var overrideAdminCharge=parseFloat((_this.billingStep2Details.overrideAdminPrice-_this.planDetailsPrimary.planAdminNextChargeAmount)*(_this.planDetailsPrimary.remainingChargableDays/daysInMonth)).toFixed(2);proAdminAmount=overrideAdminCharge<0?0:parseFloat(overrideAdminCharge).toFixed(2)}else _this.billingStep2Details.numAdmin>_this.planDetailsPrimary.availalbeAdminSubscriptions&&(proAdminAmount=parseFloat(_this.planDetailsPrimary.unitAdminPrice/daysInMonth*(_this.billingStep2Details.numAdmin-_this.planDetailsPrimary.availalbeAdminSubscriptions)*_this.planDetailsPrimary.remainingChargableDays).toFixed(2));_this.billingStep2Details.chargeAmount=Math.round(parseFloat(splErtiPrice)+parseFloat(proMemAmount)+parseFloat(proAdminAmount)),"Custom"!==_this.billingStep2Details.billingCycle?_this.billingStep2Details.billingCycleTotal=Math.round((billingCycleMonths[_this.billingStep2Details.billingCycle.toLowerCase().replace("-","")]?billingCycleMonths[_this.billingStep2Details.billingCycle.toLowerCase().replace("-","")]:0)*(parseFloat(_this.monthlyPlatformLicensePrice)+parseFloat(_this.monthlyAdminPrice)+parseFloat(_this.monthlyMemberPrice))):_this.billingStep2Details.billingCycleTotal=Math.round((parseInt(_this.billingStep2Details.noOfMonths,10)?parseInt(_this.billingStep2Details.noOfMonths,10):0)*(parseFloat(_this.monthlyPlatformLicensePrice)+parseFloat(_this.monthlyAdminPrice)+parseFloat(_this.monthlyMemberPrice)))}}function processBillingStep2(){if(_this.step2Errors=null,_this.step2Submited=!1,_this.serverErrors=!1,_this.billingStep2.$valid){var _data
;"create"===_this.step2Mode?_data=$("#spBillingStep2 :not(.serialize-ignore)").serialize().replace(/_F0_/g,"%5B0%5D.").replace(/_F1_/g,"%5B0%5D.").replace(/_F2_/g,"%5B0%5D.").replace(/_F3/g,"").replace(/_F4/g,""):"edit"===_this.step2Mode&&(_this.billingStep2Details.Primary&&!_this.billingStep2Details.IntelligentHiring||!_this.billingStep2Details.Primary&&_this.billingStep2Details.IntelligentHiring?_data=$("#spBillingStep2 :not(.serialize-ignore)").serialize().replace(/_F0_/g,"%5B0%5D.").replace(/_F1_/g,"%5B0%5D.").replace(/_F2_/g,"%5B0%5D.").replace(/_F3/g,"").replace(/_F4/g,""):_this.billingStep2Details.Primary&&_this.billingStep2Details.IntelligentHiring&&(_data=$("#spBillingStep2 :not(.serialize-ignore)").serialize().replace(/_F0_/g,"%5B1%5D.").replace(/_F1_/g,"%5B0%5D.").replace(/_F2_/g,"%5B1%5D.").replace(/_F3/g,"").replace(/_F4/g,""))),ajaxService.getAjaxResponse({url:"create"===_this.step2Mode?_this.services.step2Submit:_this.services.step2Update,data:"create"===_this.step2Mode?_data:_data+"&accountId="+_this.accountId}).then(function(response){if("true"===response.Success)$localStorage.set("planAdded",$rootScope.pullInterNationalization("pricing.planAdded")),window.location.href="/sp/sysAdmin/alternateBilling/viewDetailAccount?accountId="+(response.accountId||_this.accountId);else if(null!==response.error){var errorMessage="";for(var key in response.error)errorMessage=response.error[key];_this.serverErrors=!0,_this.step2Errors=errorMessage}})}else _this.step2Submited=!0,console.log(_this.billingStep2.$error)}function securityRules(){ngDialog.open({template:_this.dialogTemplates.passwordRules}),$rootScope.$on("ngDialog.opened",function(e,$dialog){$timeout(function(){$(".contentArea").scrollTop(0)},100)})}function getFeatures(){if(void 0===$localStorage.get("plansAllFeatures")||null===$localStorage.get("plansAllFeatures"))ajaxService.getAjaxResponse({url:_this.services.getFeatures}).then(function(response){if("true"===response.Success){$localStorage.set("plansAllFeatures",response);for(var i=0;i<response.plansFeatures.length;i++)if("Primary"===response.plansFeatures[i].spPlanType){_this.plansFeatures=response.plansFeatures[i].spFeatures;break}}else sharedProperties.ajaxError(response)});else for(var i=0;i<$localStorage.get("plansAllFeatures").plansFeatures.length;i++)if("Primary"===$localStorage.get("plansAllFeatures").plansFeatures[i].spPlanType){_this.plansFeatures=$localStorage.get("plansAllFeatures").plansFeatures[i].spFeatures;break}}function processBillingStep1(){_this.step1Submited=!1,_this.billingStep1.$valid&&_this.billingStep1Details.numEmp>0?(_this.step1Submited=!1,ajaxService.getAjaxResponse({url:_this.services.step1Submit,data:$.param(_this.billingStep1Details)}).then(function(response){"true"===response.Success?window.location.href="/sp/sysAdmin/alternateBilling/businessStep2Form#mode=create":null!==response.error&&sharedProperties.ajaxError(response.error)})):_this.step1Submited=!0}function resetAddress(){_this.billingStep1Details.zip="",_this.billingStep1Details.city="",_this.billingStep1Details.state="",_this.billingStep1Details.address1="",_this.billingStep1Details.address2=""}function stateCheck(country){switch(_this.showStatesUS=!1,_this.showStatesCanada=!1,_this.showStatesOthers=!1,country){case"United States":_this.showStatesUS=!0;break;case"Canada":_this.showStatesCanada=!0;break;case"US":_this.showStatesUS=!0;break;case"CA":_this.showStatesCanada=!0;break;default:_this.showStatesUS=!1,_this.showStatesCanada=!1,_this.showStatesOthers=!0}}var _this=this;$localStorage.remove("plansAllFeatures"),_this.countries=$localStorage.get("countriesFullList").countries;var billingCycleMonths={monthly:1,quaterly:3,semiannually:6,anually:12},daysInMonth=30;_this.showStatesUS=!1,_this.showStatesCanada=!1,_this.showStatesOthers=!0,_this.stateCheck=stateCheck,_this.resetAddress=resetAddress,_this.services={step1Submit:"/sp/sysAdmin/alternateBilling/signup/business",existingMember:"/sp/sysAdmin/alternateBilling/allCompanyMembers",allCompanies:"/sp/sysAdmin/hk/getCompanyList",getFeatures:"/sp/sysAdmin/alternateBilling/getPlansFeature",step2Submit:"/sp/sysAdmin/alternateBilling/signup/business/account",step2Update:"/sp/sysAdmin/alternateBilling/updateAccount",accountDetails:"/sp/sysAdmin/alternateBilling/account/businessAccountDetails",addCredit:"/sp/sysAdmin/alternateBilling/account/addCredit"},_this.dialogTemplates={existingMember:"/sp/resources/html/sysAdmin/alternateBilling/memberModal.html",passwordRules:"/sp/resources/html/sysAdmin/alternateBilling/password-rules.html",addCredit:"/sp/resources/html/sysAdmin/alternateBilling/addCreditsBilling.html"},_this.availablePlans=["Primary","IntelligentHiring"],_this.billingStep1={},_this.billingStep2={},_this.billingStep1Details={},_this.step1Submited=!1,_this.billingStep2Details={},_this.billingStep2Details.isOverrideAmount=!1,_this.billingStep2Details.isOverrideAdminAmount=!1,_this.billingStep2Details.primaryFeaturesList="",_this.billingStep2Details.creditBalance=0,_this.step2Submited=!1,_this.billingStep2HiringDetails={},_this.billingStep2HiringDetails.isOverrideAmount=!1,_this.billingStep2HiringDetails.isOverrideAdminAmount=!1,_this.billingStep2HiringDetails.hiringFeaturesList="Hiring",_this.billingStep2HiringDetails.isBundle=!0,_this.billingStep2HiringDetails.creditBalance=0,_this.bundleMultiplier=10,_this.agreementTotalPrice=0,_this.monthlyPlatformLicensePrice=0,_this.monthlyAdminPrice=0,_this.monthlyMemberPrice=0,_this.agreementTotalPriceHiring=0,_this.monthlyPlatformLicensePriceHiring=0,_this.monthlyAdminPriceHiring=0,_this.monthlyMemberPriceHiring=0,_this.monthsInYear=12,_this.planFeaturesList=["Prism","Erti","PrismLens","RelationShipAdvisor"],_this.searchTag=[],_this.isCompanySelect=!0,_this.isMemberSelect=!1,_this.inputRequired=!1,_this.disableEmail=!1,_this.disableEmailHiring=!1,_this.selectedUser=null,_this.emailMemberList=[],_this.tags=[],_this.submitDisable=!0,_this.step2Mode="create",_this.step2planList=["Primary"],_this.viewForm="Primary",_this.plansFeatures=[],_this.accountDetails={},_this.companyDetails={},_this.disableHiringOpt=!1,_this.disableErtiOpt=!1,_this.billingStep2Details.Primary=!1,_this.billingStep2Details.IntelligentHiring=!1,_this.ignoreErtiForm=!0,_this.ignoreHiringForm=!0,_this.disableErtiForm=!0,_this.disableHiringForm=!0,_this.primaryPlanAvailable=!1,_this.hiringPlanAvailable=!1,_this.addCreditForm={},_this.creditInfo={},_this.creditFormSubmit=!1,_this.currentPlanInfo={},_this.creditErrors=null,_this.step2Errors=null,_this.serverErrors=!1,_this.creditSubmitErrors=!1,_this.editPrimaryFeatures=[],_this.hiringPlanActive=!0,_this.primaryPlanActive=!0,_this.billingStep2HiringDetails.billingCycleTotal=0,_this.getDetailsType=null,_this.billingStep2Details.existingMember=!1,_this.billingStep2HiringDetails.existingMember=!1,_this.billingStep2Details.tagsList="",_this.billingStep2HiringDetails.tagsList="",_this.billingStep2Details.tags=[],_this.billingStep2HiringDetails.tags=[],_this.initStep2=initStep2,_this.changeTabs=changeTabs,_this.processHashParams=processHashParams,_this.resetForm=resetForm,_this.processBillingStep1=processBillingStep1,_this.getFeatures=getFeatures,_this.securityRules=securityRules,_this.processBillingStep2=processBillingStep2,_this.updatePricing=updatePricing,_this.updateFeatureSelection=updateFeatureSelection,_this.getExistingMember=getExistingMember,_this.getAllMembers=getAllMembers,_this.loadTags=loadTags,_this.tagAdded=tagAdded,_this.tagRemoved=tagRemoved,_this.updateSelectedMember=updateSelectedMember,_this.generateTagsList=generateTagsList,_this.pageRedirect=pageRedirect,_this.updateBundles=updateBundles,_this.getAccountDetails=getAccountDetails,_this.validateBeforeSubmit=validateBeforeSubmit,_this.updateFormView=updateFormView,_this.updateRemainingDays=updateRemainingDays,_this.showAddCredit=showAddCredit,_this.processCredit=processCredit,_this.updateProRatedPricing=updateProRatedPricing,_this.getDetails=getDetails,_this.getPrimaryDetails=getPrimaryDetails,_this.getTotalPrice=getTotalPrice}angular.module("spApp").controller("spBillingCtrl",spBillingCtrl),spBillingCtrl.$inject=["$scope","$http","$element","$attrs","ajaxService","$location","$state","$localStorage","sharedProperties","$timeout","ngDialog","$q","$rootScope"];