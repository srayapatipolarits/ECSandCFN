angular.module("spApp").directive("teamAdvisorErti",["sharedProperties","$rootScope","ngDialog","$filter","$localStorage","$q","$timeout","$state","ajaxService",function(sharedProperties,$rootScope,ngDialog,$filter,$localStorage,$q,$timeout,$state,ajaxService){var teamAdvisorErti={restrict:"EA",replace:!0,templateUrl:function(element,attrs){return"/sp/resources/html/common/"+attrs.urlSrc},link:function(scope,element,attrs){function matchSort(order){_this.memberList.sort(function(a,b){var af=a.matchResult.matchPercent,bf=b.matchResult.matchPercent;switch(order){case"asc":return af===bf?0:+(af>bf)||-1;case"dsc":return af===bf?0:+(af<bf)||-1}})}function compareOperation(){_this.returnMemberList(_this.pageSetting.pageSize),_this.responseReceived=!0}function getTeamAdvisor(list){var memberIds=list.map(function(e){return e.userId});ajaxService.getAjaxResponse({url:"/sp/groupLead/getMemberPortraits",headers:{"Content-Type":"application/json"},data:{userIds:memberIds,pa:!1}}).then(function(response){"true"===response.Success?(_this.masterMemberList=response.teamDynamics.usersList,_this.memberList=angular.copy(_this.masterMemberList),_this.memberListTotal=response.teamDynamics.usersList.length,_this.teamAdvisor=response.teamDynamics.results,_this.taPersonality=response.teamDynamics.results.Personality,_this.taUnderPresssure=response.teamDynamics.results.UnderPresssure,_this.taProcessing=response.teamDynamics.results.Processing,_this.taMotivation=response.teamDynamics.results.Motivation,_this.taConflictManagement=response.teamDynamics.results.ConflictManagement,_this.taDecisionMaking=response.teamDynamics.results.DecisionMaking,_this.taFundamentalNeeds=response.teamDynamics.results.FundamentalNeeds,compareOperation()):null!==response.error&&(sharedProperties.ajaxError(response.error),ngDialog.closeAll())})}function init(){_this.selectedViewType="graphs",_this.isTeamAdvisor=!1,_this.isTeamAdvisorCheck=!1,_this.picMap=angular.copy(_this.picMapOriginal);var _list=[];_this.selectedMasterList=[],_this.selectedMemberList=[],_this.masterMemberList=[],_this.memberList=[],_this.selectedMasterList="dashboardGroups"===_this.compareType?angular.copy(_this.parentScope.ctrl.pageSetting.userEmail.email):angular.copy(_this.parentScope.ctrl.ps_pageSetting.userEmail.email),_list=angular.copy(_this.selectedMasterList),_this.selectedMemberList=_list.filter(function(e){return"VALID"===e.userStatus}),_this.groupName="dashboardGroups"===_this.compareType?_this.parentScope.ctrl.pageSetting.selectedSearch||$rootScope.pullInterNationalization("dashboard.groups.all"):_this.parentScope.ctrl.ps_profileList.name,getTeamAdvisor(_this.selectedMemberList)}var _this=scope;_this.masterMemberList=[],_this.memberList=[],_this.memberListTotal=0,_this.parentScope=scope.$parent,_this.compareType=attrs.type,_this.compareId=attrs.id,_this.compareRoleId=null,_this.compareDetails={},_this.responseReceived=!1,_this.pageSetting={pageSize:12,lastPredicate:"name",lastReverse:!1,disabledInfinite:!1,textSearching:"",filterOptions:null},_this.originalpageSetting=angular.copy(_this.pageSetting),_this.gridLastCol=0,_this.gridClearCol=0,_this.gridUpdated=!1,_this.graphType=-1,_this.graphSelector=null,_this.motivationGraphType="why",_this.motivationGraphSelected="why",_this.graphLabelList={learning:[]},_this.filteredRolesUsersList=[],_this.selectedMasterList=[],_this.selectedMemberList=[],_this.teamAdvisor=[],_this.pictureList=[],_this.selectedViewType="graphs",_this.isTeamAdvisor=!1,_this.isTeamAdvisorCheck=!1,_this.groupName="",_this.picMapOriginal={taPersonality:{Versatile:[],Adaptable:[],Powerfull:[],Precise:[],equalTraitsUserIds:{Versatile:[],Adaptable:[],Powerfull:[],Precise:[]},bigPicture:[],detailOriented:[],missionOriented:[],relationOriented:[]},taUnderPresssure:{Versatile:[],Adaptable:[],Powerfull:[],Precise:[],equalTraitsUserIds:{Versatile:[],Adaptable:[],Powerfull:[],Precise:[]},bigPicture:[],detailOriented:[],missionOriented:[],relationOriented:[]},taProcessing:{Spontaneous:[],Orderly:[],External:[],Internal:[],Intuitive:[],Concrete:[],Affective:[],Cognitive:[],equalTraitsUserIds:{AffectiveCognitive:[],ConcreteIntuitive:[],ExternalInternal:[],OrderlySpontaneous:[]}},taMotivation:{PrefersProcess:[],TaskCompletion:[],AttainmentOfGoals:[],RecognitionForEffort:[],Compliance:[],Power:[],Activity:[],Affiliation:[],ReceiveDirection:[],ExchangeOfIdeas:[],SelfAffirmed:[],AffirmedByOthers:[],Freedom:[],Consistency:[],Accomplishment:[],Hygiene:[],equalTraitsUserIds:{ActivityAffiliation:[],AttainmentGoalsRecognitionEffort:[],ExchangeOfIdeaReceiveDirection:[],FeedomConsitency:[],HygieneAccomplishment:[],PowerCompliance:[],SelfAffirmedAffirmedByOthers:[],TaskCompletionPreferProcess:[]}},taConflictManagement:{Accommodate:[],Collaborate:[],Avoid:[],Compete:[],Compromise:[],equalTraitsUserIds:{Accommodate:[],Collaborate:[],Avoid:[],Compete:[],Compromise:[]}},taDecisionMaking:{Careful:[],Rapid:[],Inward:[],Outward:[],equalTraitsUserIds:{InwardOutward:[],RapidCareful:[]}},taFundamentalNeeds:{Significance:[],Control:[],Security:[],equalTraitsUserIds:{Significance:[],Control:[],Security:[]}}},_this.picFlags=[],_this.picMapLimitTraits=10,_this.picMapLimitAdvisor=5,function(){$(window).resize(function(){$timeout(function(){$(".roles-compare-view, .roles-compare-wrapper").css({"min-height":$(window).outerHeight()}),$(window).width()>=1400&&scope.$apply(function(){_this.gridLastCol=Math.floor($(".roles-compare-listing").outerWidth()/350),_this.gridClearCol=_this.gridLastCol+1}),$(window).width()<1400&&scope.$apply(function(){_this.gridLastCol=3,_this.gridClearCol=4}),$(window).width()<1107&&scope.$apply(function(){_this.gridLastCol=2,_this.gridClearCol=3})},100)})}(),_this.personalityInnerLabelMap=function(list){var _list=_this[list],mList=angular.copy(_this.masterMemberList),flag=list+"innerMap",bigPicture=_list.Powerfull.traitsMap.Powerfull.length&&_list.Versatile.traitsMap.Versatile?_list.Powerfull.traitsMap.Powerfull.concat(_list.Versatile.traitsMap.Versatile).unique():[],detailOriented=_list.Precise.traitsMap.Precise.length&&_list.Adaptable.traitsMap.Adaptable.length?_list.Precise.traitsMap.Precise.concat(_list.Adaptable.traitsMap.Adaptable).unique():[],missionOriented=_list.Powerfull.traitsMap.Powerfull.length&&_list.Precise.traitsMap.Precise?_list.Powerfull.traitsMap.Powerfull.concat(_list.Precise.traitsMap.Precise).unique():[],relationOriented=_list.Versatile.traitsMap.Versatile.length&&_list.Adaptable.traitsMap.Adaptable.length?_list.Versatile.traitsMap.Versatile.concat(_list.Adaptable.traitsMap.Adaptable).unique():[];if(_this.picFlags.indexOf(flag)===-1){for(var i=0;i<mList.length;i++)bigPicture.length&&bigPicture.indexOf(mList[i].id)!==-1&&_this.picMap[list].bigPicture.push(mList[i]),detailOriented.length&&detailOriented.indexOf(mList[i].id)!==-1&&_this.picMap[list].detailOriented.push(mList[i]),missionOriented.length&&missionOriented.indexOf(mList[i].id)!==-1&&_this.picMap[list].missionOriented.push(mList[i]),relationOriented.length&&relationOriented.indexOf(mList[i].id)!==-1&&_this.picMap[list].relationOriented.push(mList[i]);_this.picFlags.push(flag)}},_this.generatePicMap=function(list){var _list=_this[list],mList=angular.copy(_this.masterMemberList);if(_this.picFlags.indexOf(list)===-1){for(var key in _list){if(_list[key]&&Object.keys(_list[key].traitsMap).length){var _obj=_list[key].traitsMap;for(var key1 in _obj)for(var i=0;i<mList.length;i++)_obj[key1].indexOf(mList[i].id)!==-1&&_this.picMap[list][key1].push(mList[i])}if(_list[key]&&_list[key].equalTraitsUserIds.length)for(var j=0;j<mList.length;j++)_list[key].equalTraitsUserIds.indexOf(mList[j].id)!==-1&&_this.picMap[list].equalTraitsUserIds[key].push(mList[j])}"taPersonality"!==list&&"taUnderPresssure"!==list||_this.personalityInnerLabelMap(list),_this.picFlags.push(list)}},_this.setPicMap=function(id){switch(id){case"1":_this.generatePicMap("taProcessing");break;case"2":case"2a":case"2b":_this.generatePicMap("taMotivation");break;case"3":_this.generatePicMap("taConflictManagement");break;case"4":_this.generatePicMap("taFundamentalNeeds");break;case"5":_this.generatePicMap("taDecisionMaking");break;default:_this.generatePicMap("taPersonality"),_this.generatePicMap("taUnderPresssure")}},_this.toggleTeamAdvisor=function(flag){_this.isTeamAdvisorCheck=flag},_this.updateSelectedViewType=function(type){"graphs"===type?(_this.selectedView=type,_this.motivationGraphSelected="why",_this.graphType=-1,_this.isTeamAdvisor=!1,_this.isTeamAdvisorCheck=!1,_this.motivationGraphSelected="why",_this.graphSelector="",$('select[name="graphSelector"]').prop("selectedIndex",0)):"traits"===type&&(_this.selectedView=type,_this.graphType=-1,_this.setPicMap(_this.graphType),_this.isTeamAdvisor=!1,_this.isTeamAdvisorCheck=!1,_this.motivationGraphSelected="why",_this.graphSelector="",$('select[name="graphSelector"]').prop("selectedIndex",0))},_this.getGraphLabel=function(graphObj,memberId,graphType){"learning"===graphType&&(_this.graphLabelList.learning[memberId]=Object.keys(graphObj).reduce(function(a,b){return graphObj[a]>graphObj[b]?a:b}))},_this.customOrderBy=function(sort){switch(_this.pageSetting.textSearching="",sort){case"matchAO":matchSort("asc");break;case"matchDO":matchSort("dsc");break;case"nameDO":_this.order("name",!0);break;default:_this.pageSetting.filterOptions=null,_this.order("name",!1)}},_this.displayMotivationGraph=function(grpahType){_this.motivationGraphSelected=grpahType},_this.updateGraphs=function(id){"undefined"==typeof id||null===id||""===id?_this.graphType=-1:id!==_this.graphType&&(_this.graphType=id),"traits"===_this.selectedView&&_this.setPicMap(_this.graphType),_this.motivationGraphType="why",_this.motivationGraphSelected="why"},_this.updateCompareLayout=function(){$(".roles-compare-view, .roles-compare-wrapper").css({"min-height":$(window).outerHeight()}),$(window).width()<1400&&(_this.gridLastCol=3,_this.gridClearCol=4),$(window).width()<1107&&(_this.gridLastCol=2,_this.gridClearCol=3),$(window).width()>=1400&&(_this.gridLastCol=Math.floor($(".roles-compare-listing").outerWidth()/335),_this.gridClearCol=_this.gridLastCol+1)},_this.order=function(predicate,reverse){_this.pageSetting.lastPredicate=predicate,_this.pageSetting.lastReverse=reverse;var orderedList=$filter("orderBy")(_this.memberList,_this.pageSetting.lastPredicate,_this.pageSetting.lastReverse);_this.memberList=function(array,key){if("name"===key){for(var list=[],empty=[],i=0;i<array.length;i++)null!==array[i][key]&&""!==array[i][key]&&"undefined"!=typeof array[i][key]?list.push(array[i]):empty.push(array[i]);return $.merge(list,empty)}return orderedList}(orderedList,_this.pageSetting.lastPredicate)},_this.active=function(event,setting){_this.pageSetting.lastPredicate=setting.predicate,_this.pageSetting.lastReverse=setting.reverse,sharedProperties.toggleFilterClick(event,_this.pageSetting.lastPredicate),_this.order(_this.pageSetting.lastPredicate,_this.pageSetting.lastReverse)},_this.infinteScroll=function(pageSize){_this.pageSetting.disabledInfinite||(_this.pageSetting.pageSize=pageSize,pageSize>=_this.masterMemberList.length&&(_this.pageSetting.disabledInfinite=!0,_this.pageSetting.pageSize=_this.masterMemberList.length)),$timeout(function(){_this.updateCompareLayout()},200)},_this.returnMemberList=function(){if(!_this.masterMemberList.length)return!0;_this.pageSetting.pageSize=_this.originalpageSetting.pageSize,_this.pageSetting.disabledInfinite=!1;var result=_this.masterCopy?_this.masterMemberList:_this.memberList;_this.memberList=result.filter(function(e){return sharedProperties.singleElementSearch(_this.pageSetting.textSearching,e,2)}),_this.order(_this.pageSetting.lastPredicate,_this.pageSetting.lastReverse),_this.masterCopy=!0,$timeout(function(){_this.updateCompareLayout()},200)},_this.closeRolesCompareView=function(){ngDialog.closeAll(),"roles"===_this.compareType&&($localStorage.set("selectedRoleId",_this.compareRoleId),$state.transitionTo("roleDetails",{id:_this.compareRoleId},{reload:!0}))},init(_this.compareType)}};return teamAdvisorErti}]);